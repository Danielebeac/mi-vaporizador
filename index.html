<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRAFTY+ V10 ROBUST</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #000; color: #fff; text-align: center; padding: 20px; margin: 0; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        /* HEADER */
        .header { display: flex; justify-content: space-between; align-items: center; max-width: 400px; margin: 0 auto 10px auto; }
        .logo { font-weight: 900; font-size: 20px; letter-spacing: -1px; }
        .logo span { color: #00e5ff; }
        .badge { padding: 4px 10px; border-radius: 12px; font-size: 10px; font-weight: bold; background: #333; color: #777; transition: 0.3s; }
        .badge.online { background: #00ff00; color: #000; box-shadow: 0 0 10px rgba(0,255,0,0.4); }

        /* PANTALLAS */
        .screen { max-width: 380px; margin: 0 auto; display: none; }
        .visible { display: block; animation: fadein 0.5s; }
        
        .card { background: #161618; border-radius: 24px; padding: 25px; margin-bottom: 15px; border: 1px solid #222; position: relative; overflow: hidden; }

        /* VISUALIZADOR */
        .temp-val { font-size: 72px; font-weight: 200; line-height: 1; letter-spacing: -3px; }
        .temp-unit { font-size: 24px; color: #555; position: absolute; top: 35px; }
        
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #333; }
        .label { font-size: 11px; color: #666; text-transform: uppercase; letter-spacing: 1px; }
        .val { font-size: 18px; font-weight: 600; }
        .orange { color: #ff9f43; } .green { color: #2ecc71; }

        /* CONTROLES */
        .slider-container { display: flex; align-items: center; justify-content: space-between; background: #222; border-radius: 16px; padding: 5px; margin-bottom: 15px; }
        .btn-round { width: 50px; height: 50px; border-radius: 14px; border: none; background: #333; color: #fff; font-size: 24px; cursor: pointer; }
        .btn-round:active { background: #555; }
        input[type="number"] { background: transparent; border: none; color: #fff; font-size: 28px; width: 80px; text-align: center; font-weight: bold; }

        .btn-main { width: 100%; border: none; padding: 18px; border-radius: 16px; font-size: 16px; font-weight: 700; cursor: pointer; margin-bottom: 10px; transition: transform 0.1s; }
        .btn-main:active { transform: scale(0.97); }
        
        .btn-heat { background: linear-gradient(135deg, #ff6b6b, #ee5253); color: white; }
        .btn-boost { background: linear-gradient(135deg, #feca57, #ff9f43); color: #000; }
        .btn-cata { background: linear-gradient(135deg, #a55eea, #8854d0); color: white; }
        .btn-stop { background: #2d3436; color: #ccc; }
        .btn-disco { background: transparent; border: 1px solid #444; color: #666; font-size: 12px; padding: 10px; margin-top: 10px; }
        
        .cata-status { font-size: 13px; color: #a55eea; margin-top: 5px; font-weight: bold; height: 20px; margin-bottom: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}

        @keyframes fadein { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="header">
        <div class="logo">CRAFTY<span>+</span></div>
        <div id="statusBadge" class="badge">OFFLINE</div>
    </div>

    <div id="view-connect" class="screen visible">
        <div class="card" style="padding: 50px 20px;">
            <div style="font-size: 50px; margin-bottom: 20px;">üîå</div>
            <p style="color: #666; margin-bottom: 30px;">Conecta para iniciar V10 Robust.</p>
            <button class="btn-main btn-heat" onclick="conectar()">CONECTAR</button>
        </div>
    </div>

    <div id="view-app" class="screen">
        
        <div class="card">
            <div style="position: relative; display: inline-block;">
                <span id="tempActual" class="temp-val">--</span>
                <span class="temp-unit">¬∞C</span>
            </div>
            
            <div class="info-grid">
                <div>
                    <div class="label">OBJETIVO</div>
                    <div id="tempTarget" class="val orange">--¬∞C</div>
                </div>
                <div>
                    <div class="label">BATER√çA</div>
                    <div id="batteryLevel" class="val green">--%</div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="slider-container">
                <button class="btn-round" onclick="ajustar(-1)">-</button>
                <input type="number" id="inputTemp" value="180" readonly>
                <button class="btn-round" onclick="ajustar(1)">+</button>
            </div>
            
            <button class="btn-main btn-heat" onclick="manualEncender()">üî• ENCENDER / ACTUALIZAR</button>
            <button class="btn-main btn-boost" onclick="activarBoost()">‚ö° BOOST (+15¬∞C)</button>
            
            <hr style="border-color:#333; margin: 15px 0;">
            
            <div id="cataInfo" class="cata-status"></div>
            <button id="btnCata" class="btn-main btn-cata" onclick="iniciarCatadorRobust()">üç∑ MODO CATADOR (ROBUST)</button>
            
            <button class="btn-main btn-stop" onclick="apagarTotal()">‚ùÑÔ∏è DETENER CALENTADOR</button>
            <button class="btn-main btn-disco" onclick="desconectar()">üîå DESCONECTAR BLUETOOTH</button>
        </div>
    </div>

    <script>
        // --- CONSTANTES ---
        const UUID = {
            MAIN:   '00000001-4c45-4b43-4942-265a524f5453',
            ACTUAL: '00000011-4c45-4b43-4942-265a524f5453',
            TARGET: '00000021-4c45-4b43-4942-265a524f5453',
            BATT:   '00000041-4c45-4b43-4942-265a524f5453',
            ON:     '00000081-4c45-4b43-4942-265a524f5453',
            OFF:    '00000091-4c45-4b43-4942-265a524f5453'
        };

        let device = null;
        let char = {};
        let loop = null;
        let cataRunning = false;

        // --- CONEXI√ìN ---
        async function conectar() {
            try {
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'STORZ' }],
                    optionalServices: [UUID.MAIN]
                });

                device.addEventListener('gattserverdisconnected', onDisconnect);
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(UUID.MAIN);

                char.actual = await service.getCharacteristic(UUID.ACTUAL);
                char.target = await service.getCharacteristic(UUID.TARGET);
                char.batt   = await service.getCharacteristic(UUID.BATT);
                char.on     = await service.getCharacteristic(UUID.ON);
                char.off    = await service.getCharacteristic(UUID.OFF);

                document.getElementById('view-connect').classList.remove('visible');
                document.getElementById('view-app').classList.add('visible');
                document.getElementById('statusBadge').innerText = "ONLINE";
                document.getElementById('statusBadge').classList.add('online');

                loop = setInterval(leerDatos, 1000);

            } catch (e) { alert("Error: " + e); }
        }

        function desconectar() {
            if (device && device.gatt.connected) {
                device.gatt.disconnect();
            } else {
                onDisconnect();
            }
        }

        function onDisconnect() {
            clearInterval(loop);
            cataRunning = false;
            location.reload(); 
        }

        async function leerDatos() {
            if (!char.actual) return;
            try {
                const vT = await char.actual.readValue();
                document.getElementById('tempActual').innerText = (vT.getUint16(0, true) / 10).toFixed(1);

                const vO = await char.target.readValue();
                const o = vO.getUint16(0, true) / 10;
                document.getElementById('tempTarget').innerText = o > 0 ? o + "¬∞C" : "OFF";

                const vB = await char.batt.readValue();
                document.getElementById('batteryLevel').innerText = vB.getUint16(0, true) + "%";
            } catch (e) {}
        }

        // --- CONTROL Y VERIFICACI√ìN ---
        async function ajustar(delta) {
            const input = document.getElementById('inputTemp');
            let val = parseInt(input.value) + delta;
            if (val > 210) val = 210;
            if (val < 40) val = 40;
            input.value = val;
            
            // Env√≠o r√°pido
            if (char.target) {
                try { await write(char.target, val * 10); } catch(e) {}
            }
        }

        // NUEVA FUNCI√ìN MAESTRA: Env√≠a y VERIFICA que se haya enviado
        async function enviarTemperaturaSegura(grados) {
            let intentos = 0;
            let exito = false;

            while (intentos < 3 && !exito) {
                try {
                    // 1. Enviar Target
                    await write(char.target, grados * 10);
                    // 2. Encender
                    await write(char.on, 1);
                    
                    // 3. Pausa breve para que el chip procese
                    await new Promise(r => setTimeout(r, 600));

                    // 4. VERIFICACI√ìN: ¬øEl vape cambi√≥ su objetivo?
                    const lectura = await char.target.readValue();
                    const leido = lectura.getUint16(0, true) / 10;

                    if (Math.abs(leido - grados) < 1) {
                        exito = true; // ¬°S√≠, lo hizo!
                    } else {
                        console.log(`Intento ${intentos+1} fallido. Le√≠do: ${leido}, Esperado: ${grados}`);
                        // Si fall√≥, mostramos feedback visual si estamos en catador
                        if (cataRunning) {
                            document.getElementById('cataInfo').innerText = `‚ö†Ô∏è Reintentando enviar ${grados}¬∞C...`;
                        }
                    }
                } catch (e) { console.log(e); }
                intentos++;
            }
            return exito;
        }

        async function manualEncender(tempOverride = null) {
            const val = tempOverride || document.getElementById('inputTemp').value;
            await enviarTemperaturaSegura(val);
            if(navigator.vibrate) navigator.vibrate(50);
        }

        async function activarBoost() {
            let actual = parseInt(document.getElementById('inputTemp').value);
            let boostTemp = actual + 15;
            if (boostTemp > 210) boostTemp = 210;
            document.getElementById('inputTemp').value = boostTemp;
            await manualEncender(boostTemp);
            alert(`üöÄ BOOST: Subiendo a ${boostTemp}¬∞C`);
        }

        // --- MODO CATADOR ROBUST ---
        async function iniciarCatadorRobust() {
            if (cataRunning) return; 
            cataRunning = true;

            const pasos = [175, 185, 195];
            const tiempoSesion = 45; 
            const btn = document.getElementById('btnCata');
            const info = document.getElementById('cataInfo');

            btn.style.background = "#444";
            btn.innerText = "‚õî DETENER";
            btn.onclick = () => { location.reload(); };

            for (let i = 0; i < pasos.length; i++) {
                if (!cataRunning) break;
                
                const target = pasos[i];
                info.innerText = `Paso ${i+1}/${pasos.length}: Enviando ${target}¬∞C...`;
                document.getElementById('inputTemp').value = target;

                // USAR LA FUNCI√ìN SEGURA
                const enviadoOK = await enviarTemperaturaSegura(target);
                
                if (!enviadoOK) {
                    info.innerText = "‚ùå Error comunicaci√≥n. Saltando paso...";
                    await new Promise(r => setTimeout(r, 2000));
                    continue; // Saltamos al siguiente si falla mucho
                }

                info.innerText = `Subiendo a ${target}¬∞C...`;

                // Esperar llegada con timeout de 90s
                await esperarLlegadaTemperatura(target);

                if (!cataRunning) break;

                // Cuenta regresiva
                for (let s = tiempoSesion; s > 0; s--) {
                    if (!cataRunning) break;
                    info.innerText = `üî• Saboreando ${target}¬∞C - Quedan ${s}s`;
                    await new Promise(r => setTimeout(r, 1000));
                }
            }

            if (cataRunning) {
                info.innerText = "‚úÖ ¬°Sesi√≥n Finalizada!";
                alert("Modo Catador Terminado");
                cataRunning = false;
                btn.style.background = ""; 
                btn.innerText = "üç∑ MODO CATADOR (ROBUST)";
                btn.onclick = iniciarCatadorRobust;
            }
        }

        async function esperarLlegadaTemperatura(meta) {
            return new Promise(resolve => {
                let intentos = 0;
                const check = setInterval(() => {
                    intentos++;
                    const actual = parseFloat(document.getElementById('tempActual').innerText);
                    
                    if (!cataRunning) { clearInterval(check); resolve(); return; }

                    if (actual >= (meta - 3)) {
                        clearInterval(check);
                        resolve();
                    }
                    
                    // Timeout de seguridad 90s
                    if (intentos > 90) { clearInterval(check); resolve(); }
                }, 1000);
            });
        }

        async function apagarTotal() {
            cataRunning = false;
            document.getElementById('cataInfo').innerText = "Detenido.";
            await write(char.off, 1);
            await write(char.target, 0);
        }

        async function write(c, v) {
            const b = new ArrayBuffer(2);
            new DataView(b).setUint16(0, v, true);
            await c.writeValue(b);
        }
    </script>
</body>
</html>
