<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crafty+ (Modo Espejo)</title>
    <style>
        body { font-family: 'Courier New', monospace; background-color: #0d0d0d; color: #00ffcc; text-align: center; padding: 20px; }
        h1 { text-shadow: 0 0 10px #00ffcc; margin-bottom: 5px; }
        .card { background: #1a1a1a; border: 1px solid #333; border-radius: 12px; padding: 20px; margin: 15px auto; max-width: 320px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .value { font-size: 48px; font-weight: bold; color: #fff; margin: 10px 0; }
        button { background: linear-gradient(45deg, #00b09b, #96c93d); color: #000; font-weight: bold; border: none; padding: 15px 30px; font-size: 18px; border-radius: 30px; cursor: pointer; width: 100%; transition: transform 0.2s; }
        button:active { transform: scale(0.95); }
        input { font-size: 24px; padding: 5px; width: 80px; text-align: center; background: #333; border: none; color: white; border-radius: 5px; }
        #logs { font-size: 10px; color: #555; text-align: left; margin-top: 30px; font-family: monospace; border-top: 1px solid #333; padding-top: 10px; }
    </style>
</head>
<body>

    <h1>üîÆ CRAFTY MIRROR</h1>
    <p>Conectando con UUIDs invertidos</p>

    <div id="connectPanel">
        <button onclick="connect()">üîå CONECTAR AHORA</button>
    </div>

    <div id="app" style="display:none;">
        <div class="card">
            <small>TEMPERATURA ACTUAL</small>
            <div id="tempDisplay" class="value">--.-</div>
            <small>Grados Celsius</small>
        </div>

        <div class="card">
            <small>CAMBIAR TEMPERATURA</small>
            <br><br>
            <input type="number" id="targetInput" value="180"> ¬∞C
            <br><br>
            <button onclick="setTemperature()" style="background: #e67e22;">ESTABLECER</button>
        </div>

        <div class="card">
            <small>BATER√çA</small>
            <div id="batDisplay" class="value">--%</div>
        </div>
    </div>

    <div id="logs"></div>

    <script>
        // === LA CLAVE DEL √âXITO: UUIDS INVERTIDOS ===
        // Basado en tu captura de pantalla: "4c45-4b43-4942-265a524f5453"
        const SUFFIX = '-4c45-4b43-4942-265a524f5453';
        
        const SERVICE_MAIN = '00000001' + SUFFIX; 
        const CHAR_TEMP    = '00000011' + SUFFIX; // Asumimos prefijo 11 (Temp)
        const CHAR_TARGET  = '00000021' + SUFFIX; // Asumimos prefijo 21 (Target)
        const CHAR_BATTERY = '00000040' + SUFFIX; // Asumimos prefijo 40 (Bat)

        let cache = {};

        function log(msg) {
            console.log(msg);
            document.getElementById('logs').innerHTML += `> ${msg}<br>`;
        }

        async function connect() {
            try {
                log("Solicitando dispositivo...");
                
                // 1. Pedimos el dispositivo con el UUID invertido
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'STORZ' }], 
                    optionalServices: [SERVICE_MAIN] 
                });

                log(`Conectado a: ${device.name}`);
                const server = await device.gatt.connect();
                
                // 2. Buscamos el servicio
                const service = await server.getPrimaryService(SERVICE_MAIN);
                log("Servicio principal encontrado ‚úÖ");

                // 3. Conectamos las caracter√≠sticas
                // Intentamos conectar una por una para que si falla la bater√≠a, al menos funcione la temp
                try {
                    cache['temp'] = await service.getCharacteristic(CHAR_TEMP);
                    log("Sensor Temp OK");
                } catch(e) { log("Error Temp: " + e); }

                try {
                    cache['target'] = await service.getCharacteristic(CHAR_TARGET);
                    log("Control Temp OK");
                } catch(e) { log("Error Target: " + e); }

                try {
                    cache['bat'] = await service.getCharacteristic(CHAR_BATTERY);
                    log("Sensor Bater√≠a OK");
                } catch(e) { log("Error Bater√≠a (Puede que este modelo use otro ID)"); }

                // Mostrar App
                document.getElementById('connectPanel').style.display = 'none';
                document.getElementById('app').style.display = 'block';

                // Iniciar lecturas
                setInterval(updateData, 2000);

            } catch (err) {
                alert("Error: " + err);
                log("CRITICAL ERROR: " + err);
            }
        }

        async function updateData() {
            if (cache['temp']) {
                const val = await cache['temp'].readValue();
                const cel = val.getUint16(0, true) / 10;
                document.getElementById('tempDisplay').innerText = cel.toFixed(1) + "¬∞C";
            }
            if (cache['bat']) {
                const val = await cache['bat'].readValue();
                const bat = val.getUint16(0, true);
                document.getElementById('batDisplay').innerText = bat + "%";
            }
        }

        async function setTemperature() {
            if (!cache['target']) return alert("Control no disponible");
            const num = parseInt(document.getElementById('targetInput').value);
            const buffer = new Uint16Array([num * 10]);
            await cache['target'].writeValue(buffer);
            alert(`Enviando ${num}¬∞C...`);
        }
    </script>
</body>
</html>
