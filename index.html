<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CRAFTY+ WEB APP</title>
    <link rel="apple-touch-icon" href="https://www.storz-bickel.com/media/favicon/default/favicon.ico">
    <style>
        /* --- ESTILO OFICIAL STORZ & BICKEL (CLONE) --- */
        :root {
            --sb-orange: #ef7d00; /* El naranja oficial aproximado */
            --sb-grey: #4a4a4a;
            --bg-color: #f4f4f4;
            --card-bg: #ffffff;
        }

        body { 
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; 
            background-color: var(--bg-color); 
            color: var(--sb-grey); 
            text-align: center; 
            padding: 20px; 
            margin: 0; 
            user-select: none; 
            -webkit-tap-highlight-color: transparent; 
        }
        
        /* HEADER TIPO APP */
        .header { 
            display: flex; justify-content: space-between; align-items: center; 
            max-width: 420px; margin: 0 auto 20px auto; padding: 10px;
        }
        .logo { font-weight: 800; font-size: 22px; color: var(--sb-orange); letter-spacing: -1px; }
        .logo span { color: var(--sb-grey); }
        .badge { 
            padding: 6px 12px; border-radius: 20px; font-size: 11px; 
            font-weight: 700; background: #e0e0e0; color: #888; text-transform: uppercase;
        }
        .badge.online { background: var(--sb-orange); color: #fff; }

        .screen { max-width: 400px; margin: 0 auto; display: none; }
        .visible { display: block; animation: fadein 0.4s; }
        
        /* TARJETAS BLANCAS LIMPIAS */
        .card { 
            background: var(--card-bg); 
            border-radius: 15px; 
            padding: 25px 20px; 
            margin-bottom: 15px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
            position: relative; 
        }

        /* DISPLAY PRINCIPAL */
        .temp-display { position: relative; height: 120px; display: flex; align-items: center; justify-content: center; margin-bottom: 5px; }
        .temp-val { font-size: 90px; font-weight: 300; line-height: 1; color: var(--sb-grey); }
        .temp-unit { font-size: 24px; color: #999; position: absolute; top: 15px; right: 10px; }
        
        .info-row { display: flex; justify-content: space-around; margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px; }
        .stat-box { text-align: center; }
        .label { font-size: 10px; color: #999; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
        .val { font-size: 20px; font-weight: 700; color: var(--sb-orange); }
        .val.batt { color: var(--sb-grey); }

        /* CONTROL DE TEMPERATURA (BOTONES TRIANGULARES SIMULADOS) */
        .control-panel { 
            display: flex; align-items: center; justify-content: space-between; 
            background: #fff; padding: 10px 0; margin-bottom: 20px;
        }
        
        .btn-adjust { 
            width: 60px; height: 60px; border-radius: 50%; border: none; 
            background: #eee; color: var(--sb-grey); font-size: 30px; font-weight: bold;
            cursor: pointer; transition: 0.1s; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .btn-adjust:active { background: #ddd; transform: scale(0.95); }
        
        .btn-adjust.plus { background: var(--sb-orange); color: white; }

        input[type="number"] { 
            background: transparent; border: none; color: var(--sb-grey); 
            font-size: 40px; width: 100px; text-align: center; font-weight: 600; 
            font-family: inherit;
        }

        /* BOT√ìN PRINCIPAL NARANJA */
        .btn-main { 
            width: 100%; border: none; padding: 18px; border-radius: 12px; 
            font-size: 16px; font-weight: 700; cursor: pointer; margin-bottom: 10px; 
            box-shadow: 0 4px 10px rgba(239, 125, 0, 0.2); transition: 0.2s;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .btn-heat { background: var(--sb-orange); color: white; }
        .btn-heat:active { background: #d67000; transform: scale(0.98); }

        /* BOTONES SECUNDARIOS */
        .btn-sec { 
            width: 100%; border: 1px solid #eee; background: #fff; color: #666; 
            padding: 15px; border-radius: 12px; font-size: 14px; font-weight: 600; 
            cursor: pointer; margin-bottom: 10px;
        }
        .btn-sec:active { background: #f9f9f9; }
        
        .btn-cata { 
            background: linear-gradient(135deg, #6a11cb, #2575fc); color: white; border: none; 
            box-shadow: 0 4px 10px rgba(37, 117, 252, 0.3);
        }

        .status-text { font-size: 13px; color: var(--sb-orange); font-weight: 600; height: 20px; margin: 10px 0; }
        
        @keyframes fadein { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="header">
        <div class="logo">STORZ<span>&</span>BICKEL</div>
        <div id="statusBadge" class="badge">OFFLINE</div>
    </div>

    <div id="view-connect" class="screen visible">
        <div class="card" style="padding: 80px 20px; margin-top: 20px;">
            <div style="font-size: 60px; margin-bottom: 20px; color: var(--sb-orange);">Bluetooth</div>
            <p style="color: #666; font-size: 15px; margin-bottom: 40px;">Conecta tu CRAFTY+ para comenzar.</p>
            <button class="btn-main btn-heat" onclick="conectar()">CONECTAR AHORA</button>
        </div>
    </div>

    <div id="view-app" class="screen">
        
        <div class="card">
            <div class="label" style="margin-bottom: 10px;">TEMPERATURA ACTUAL</div>
            <div class="temp-display">
                <span id="tempActual" class="temp-val">--</span>
                <span class="temp-unit">¬∞C</span>
            </div>
            
            <div class="info-row">
                <div class="stat-box">
                    <div class="label">OBJETIVO</div>
                    <div id="tempTarget" class="val">--¬∞C</div>
                </div>
                <div class="stat-box">
                    <div class="label">BATER√çA</div>
                    <div id="batteryLevel" class="val batt">--%</div>
                </div>
            </div>
        </div>

        <div class="card">
            <div id="statusText" class="status-text"></div>

            <div class="control-panel">
                <button class="btn-adjust" onclick="cambioManual(-1)">-</button>
                <input type="number" id="inputTemp" value="180" readonly>
                <button class="btn-adjust plus" onclick="cambioManual(1)">+</button>
            </div>
            
            <button class="btn-main btn-heat" onclick="accionEncender()">
                CONFIRMAR TEMPERATURA
            </button>
            
            <button class="btn-sec" onclick="accionBoost()">
                ‚ö° ACTIVAR BOOST (+15¬∞C)
            </button>
            
            <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
            
            <button id="btnCata" class="btn-main btn-cata" onclick="iniciarCataV17()">
                üç∑ MODO CATADOR (AUTO)
            </button>
            
            <button class="btn-sec" style="color: #ff4444;" onclick="accionApagar()">APAGAR CALENTADOR</button>
            <button class="btn-sec" onclick="desconectar()">DESCONECTAR BLUETOOTH</button>
        </div>
    </div>

    <script>
        // --- MOTOR V17 (QUEUE SYSTEM) - EL CEREBRO ROBUSTO ---
        const UUID = {
            MAIN:   '00000001-4c45-4b43-4942-265a524f5453',
            ACTUAL: '00000011-4c45-4b43-4942-265a524f5453',
            TARGET: '00000021-4c45-4b43-4942-265a524f5453',
            BATT:   '00000041-4c45-4b43-4942-265a524f5453',
            ON:     '00000081-4c45-4b43-4942-265a524f5453',
            OFF:    '00000091-4c45-4b43-4942-265a524f5453'
        };

        let device, char = {}, loop, cataRun = false;
        let debounceTimer = null;
        let btQueue = Promise.resolve(); // La fila india

        function addToQueue(operation) {
            btQueue = btQueue.then(operation).catch(err => console.error(err));
            return btQueue;
        }

        async function conectar() {
            try {
                // Filtro universal para m√°xima compatibilidad
                device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: [UUID.MAIN]
                });
                device.addEventListener('gattserverdisconnected', onDisconnect);
                
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(UUID.MAIN);

                char.actual = await service.getCharacteristic(UUID.ACTUAL);
                char.target = await service.getCharacteristic(UUID.TARGET);
                char.batt   = await service.getCharacteristic(UUID.BATT);
                char.on     = await service.getCharacteristic(UUID.ON);
                char.off    = await service.getCharacteristic(UUID.OFF);

                uiConnected();
                
                // Polling seguro en cola
                loop = setInterval(() => { addToQueue(leerDatos); }, 1000);

            } catch (e) { alert("Conexi√≥n cancelada o fallida"); }
        }

        function uiConnected() {
            document.getElementById('view-connect').classList.remove('visible');
            document.getElementById('view-app').classList.add('visible');
            document.getElementById('statusBadge').innerText = "CONECTADO";
            document.getElementById('statusBadge').classList.add('online');
        }

        function onDisconnect() {
            clearInterval(loop);
            cataRun = false;
            location.reload();
        }

        function desconectar() {
            if(device?.gatt?.connected) device.gatt.disconnect();
            else onDisconnect();
        }

        async function leerDatos() {
            if(!char.actual) return;
            const vT = await char.actual.readValue();
            document.getElementById('tempActual').innerText = (vT.getUint16(0, true)/10).toFixed(1);

            const vO = await char.target.readValue();
            const obj = vO.getUint16(0, true)/10;
            document.getElementById('tempTarget').innerText = obj > 0 ? obj + "¬∞C" : "OFF";

            const vB = await char.batt.readValue();
            document.getElementById('batteryLevel').innerText = vB.getUint16(0, true) + "%";
        }

        function cambioManual(delta) {
            const input = document.getElementById('inputTemp');
            let val = parseInt(input.value) + delta;
            if(val > 210) val = 210;
            if(val < 40) val = 40;
            input.value = val;
            
            if(debounceTimer) clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => { 
                addToQueue(() => enviarComando(val));
            }, 400); 
        }

        async function write(c, v) {
            if(!c) return;
            const b = new ArrayBuffer(2);
            new DataView(b).setUint16(0, v, true);
            await c.writeValue(b);
        }

        async function enviarComando(temp) {
            document.getElementById('statusText').innerText = "Sincronizando...";
            await write(char.target, temp * 10);
            await write(char.on, 1);
            await new Promise(r => setTimeout(r, 200));
            document.getElementById('statusText').innerText = "";
        }

        async function accionEncender(valOverride = null) {
            const val = valOverride || document.getElementById('inputTemp').value;
            addToQueue(() => enviarComando(val));
            if(navigator.vibrate) navigator.vibrate(50);
        }

        async function accionBoost() {
            let actual = parseInt(document.getElementById('inputTemp').value);
            let target = Math.min(actual + 15, 210);
            document.getElementById('inputTemp').value = target; 
            await accionEncender(target);
            alert(`üöÄ BOOST ACTIVADO: ${target}¬∞C`);
        }

        async function accionApagar() {
            cataRun = false;
            addToQueue(async () => {
                await write(char.off, 1);
                await write(char.target, 0);
            });
        }

        // --- MODO CATADOR (Motor V17) ---
        async function iniciarCataV17() {
            if(cataRun) return;
            cataRun = true;
            
            const pasos = [175, 185, 195];
            const btn = document.getElementById('btnCata');
            const status = document.getElementById('statusText');
            
            btn.style.background = "#4a4a4a"; // Gris oscuro para detener
            btn.innerHTML = "‚õî DETENER CATA";
            btn.onclick = () => location.reload();

            for(let i=0; i<pasos.length; i++) {
                if(!cataRun) break;
                const T = pasos[i];
                
                status.innerText = `Subiendo a ${T}¬∞C...`;
                document.getElementById('inputTemp').value = T;
                
                // Encolamos el env√≠o
                await addToQueue(() => enviarComando(T));

                // Esperamos temperatura
                await esperarTemp(T);
                if(!cataRun) break;

                for(let s=45; s>0; s--) {
                    if(!cataRun) break;
                    status.innerText = `üî• Saboreando ${T}¬∞C - ${s}s`;
                    await new Promise(r => setTimeout(r, 1000));
                }
            }
            
            if(cataRun) {
                status.innerText = "¬°Sesi√≥n Finalizada!";
                alert("Cata completada con √©xito.");
                cataRun = false;
                location.reload(); // Reset para limpiar
            }
        }

        async function esperarTemp(meta) {
            return new Promise(resolve => {
                let safety = 0;
                const check = setInterval(() => {
                    safety++;
                    const curr = parseFloat(document.getElementById('tempActual').innerText);
                    // Como el polling sigue corriendo en la cola, el valor se actualiza
                    if(!cataRun || curr >= (meta - 3) || safety > 90) {
                        clearInterval(check);
                        resolve();
                    }
                }, 1000);
            });
        }
    </script>
</body>
</html>
