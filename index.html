<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crafty+ Master Control (Fixed)</title>
    <style>
        body { font-family: 'Courier New', monospace; background-color: #050505; color: #00ffcc; text-align: center; padding: 20px; margin: 0; }
        h1 { text-shadow: 0 0 10px #00ffcc; margin-bottom: 5px; font-size: 1.5rem; }
        .status { color: #888; font-size: 0.8rem; margin-bottom: 20px; }
        
        /* Tarjetas */
        .card { background: #1a1a1a; border: 1px solid #333; border-radius: 12px; padding: 15px; margin: 15px auto; max-width: 320px; box-shadow: 0 4px 15px rgba(0,255,204,0.1); }
        .value { font-size: 48px; font-weight: bold; color: #fff; margin: 10px 0; }
        .sub-value { font-size: 14px; color: #aaa; }

        /* Botones */
        button { border: none; padding: 15px; font-size: 16px; font-weight: bold; border-radius: 8px; cursor: pointer; width: 100%; margin-top: 10px; transition: transform 0.1s; }
        button:active { transform: scale(0.98); }
        .btn-connect { background: linear-gradient(45deg, #00b09b, #96c93d); color: #000; }
        .btn-set { background: #e67e22; color: white; }
        .btn-cata { background: linear-gradient(45deg, #8e44ad, #c0392b); color: white; box-shadow: 0 0 10px #8e44ad; }
        .btn-off { background: #444; color: #fff; }

        input { font-size: 24px; padding: 5px; width: 80px; text-align: center; background: #222; border: 1px solid #444; color: white; border-radius: 5px; }
        
        /* Logs */
        #logs { font-size: 10px; color: #555; text-align: left; margin-top: 30px; border-top: 1px solid #333; padding: 10px; height: 150px; overflow-y: scroll; background: #000; }
    </style>
</head>
<body>

    <h1>üå´Ô∏è CRAFTY+ MASTER</h1>
    <div id="statusText" class="status">Desconectado</div>

    <div id="connectPanel">
        <button class="btn-connect" onclick="connect()">üîå CONECTAR DISPOSITIVO</button>
    </div>

    <div id="app" style="display:none;">
        
        <div class="card" style="border-color: #8e44ad;">
            <small>üç∑ MODO CATADOR</small>
            <div id="cataStatus" class="sub-value">Listo para iniciar</div>
            <button class="btn-cata" onclick="startCata()">‚ñ∂ INICIAR SESI√ìN</button>
            <p style="font-size:10px; color:#aaa;">Inicia en 175¬∞C y sube cada 45s</p>
        </div>

        <div class="card">
            <small>TEMPERATURA ACTUAL</small>
            <div id="tempDisplay" class="value">--.-</div>
            <small>OBJETIVO: <span id="targetDisplay">--</span>¬∞C</small>
        </div>

        <div class="card">
            <small>CONTROL MANUAL</small>
            <br><br>
            <input type="number" id="targetInput" value="180"> ¬∞C
            <button class="btn-set" onclick="setTemperature()">FIJAR TEMPERATURA</button>
            <button class="btn-off" onclick="setTemperature(0)">DETENER (OFF)</button>
        </div>

        <div class="card">
            <small>BATER√çA</small>
            <div id="batDisplay" class="value" style="font-size:24px;">--%</div>
        </div>
    </div>

    <div id="logs"></div>

    <script>
        // --- CONFIGURACI√ìN T√âCNICA (UUIDs) ---
        // Mantenemos tu l√≥gica de sufijos que funcionaba
        const SUFFIX = '-4c45-4b43-4942-265a524f5453';
        const SERVICE_MAIN = '00000001' + SUFFIX; 
        const CHAR_BATTERY = '00000003' + SUFFIX; // <--- AGREGADO: UUID Bater√≠a Real
        const CHAR_TEMP    = '00000011' + SUFFIX; 
        const CHAR_TARGET  = '00000021' + SUFFIX; 
        
        // Variables globales
        let deviceCache = null;
        let cache = {};
        let pollingInterval;

        function log(msg) {
            const logDiv = document.getElementById('logs');
            logDiv.innerHTML = `> ${msg}<br>` + logDiv.innerHTML;
        }

        async function connect() {
            try {
                log("Solicitando conexi√≥n...");
                // Usamos TU filtro original que s√≠ funciona
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'STORZ' }], 
                    optionalServices: [SERVICE_MAIN] 
                });

                deviceCache = device;
                document.getElementById('statusText').innerText = "Conectando a: " + device.name;
                
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_MAIN);
                log("Servicio principal OK");

                // --- MAPEO DE CARACTER√çSTICAS (Corregido) ---
                try { cache['temp'] = await service.getCharacteristic(CHAR_TEMP); } catch(e) { log("Error Temp: " + e); }
                try { cache['target'] = await service.getCharacteristic(CHAR_TARGET); } catch(e) { log("Error Target: " + e); }
                
                // Intentamos conectar la bater√≠a espec√≠ficamente
                try { 
                    cache['battery'] = await service.getCharacteristic(CHAR_BATTERY); 
                    log("Bater√≠a detectada correctamente");
                } catch(e) { 
                    log("No se pudo acceder a lectura directa de bater√≠a"); 
                }

                // UI setup
                document.getElementById('connectPanel').style.display = 'none';
                document.getElementById('app').style.display = 'block';

                // Iniciar bucle de lectura autom√°tica
                startPolling();

            } catch (err) {
                alert("Error de conexi√≥n: " + err);
                log("Error: " + err);
            }
        }

        async function startPolling() {
            // Leemos datos cada 2 segundos
            pollingInterval = setInterval(async () => {
                
                // 1. LEER TEMPERATURA
                if (cache['temp']) {
                    try {
                        const val = await cache['temp'].readValue();
                        const cel = val.getUint16(0, true) / 10;
                        document.getElementById('tempDisplay').innerText = cel.toFixed(1) + "¬∞C";
                    } catch(e) { console.log(e); }
                }

                // 2. LEER BATER√çA (Correcci√≥n)
                if (cache['battery']) {
                    try {
                        const val = await cache['battery'].readValue();
                        const batLevel = val.getUint16(0, true); // Storz suele usar Uint16 para bateria
                        document.getElementById('batDisplay').innerText = batLevel + "%";
                    } catch(e) { 
                         // Fallback por si es Uint8 en modelos viejos
                         try {
                             const val = await cache['battery'].readValue();
                             const batLevel = val.getUint8(0);
                             document.getElementById('batDisplay').innerText = batLevel + "%";
                         } catch(err) { console.log(err); }
                    }
                }

            }, 2000);
        }

        // --- FUNCI√ìN DE CONTROL (ENCENDER / CAMBIAR TEMP) ---
        async function setTemperature(val = null) {
            if (!cache['target']) return alert("Error: No hay conexi√≥n de control");
            
            // Si pasamos 0, es apagar. Si no, leemos el input.
            let num = val !== null ? val : parseInt(document.getElementById('targetInput').value);
            
            // Actualizar UI
            if (num > 0) {
                document.getElementById('targetDisplay').innerText = num;
                document.getElementById('targetInput').value = num;
            } else {
                document.getElementById('targetDisplay').innerText = "OFF";
            }

            // CORRECCI√ìN IMPORTANTE: Usar DataView para Little Endian
            try {
                const valorEnviar = num * 10; // Ejemplo: 180 -> 1800
                const buffer = new ArrayBuffer(2);
                const view = new DataView(buffer);
                view.setUint16(0, valorEnviar, true); // 'true' asegura el orden de bytes correcto

                await cache['target'].writeValue(buffer);
                log(`Orden enviada: ${num === 0 ? 'APAGAR' : num + '¬∞C'}`);
                
            } catch (e) {
                log("Error al escribir comando: " + e);
            }
        }

        // --- L√ìGICA MODO CATADOR ---
        async function startCata() {
            const pasos = [175, 180, 185, 190, 195];
            const tiempoEntrePasos = 45000; // 45 segundos
            
            let btn = document.querySelector('.btn-cata');
            let status = document.getElementById('cataStatus');
            
            btn.disabled = true;
            btn.style.background = "#555";
            btn.innerText = "‚è≥ SESI√ìN EN CURSO...";

            for (let i = 0; i < pasos.length; i++) {
                let temp = pasos[i];
                status.innerText = `Paso ${i+1}/${pasos.length}: Calentando a ${temp}¬∞C`;
                log(`[CATADOR] Subiendo a ${temp}¬∞C`);
                
                await setTemperature(temp);
                
                // Esperar tiempo
                if (i < pasos.length - 1) {
                    await new Promise(r => setTimeout(r, tiempoEntrePasos));
                }
            }

            status.innerText = "‚úÖ Sesi√≥n Finalizada (195¬∞C)";
            btn.disabled = false;
            btn.innerText = "‚ñ∂ INICIAR SESI√ìN";
            btn.style.background = "linear-gradient(45deg, #8e44ad, #c0392b)";
            alert("¬°Sesi√≥n de cata terminada!");
        }
    </script>
</body>
</html>
