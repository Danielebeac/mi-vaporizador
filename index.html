<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crafty+ Web App</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="https://www.storz-bickel.com/media/favicon/default/favicon.ico">
    
    <style>
        /* --- ESTILOS EXACTOS STORZ & BICKEL --- */
        :root {
            --sb-orange: #F58220; /* Naranja oficial */
            --sb-dark-blue: #002855; /* Azul barra inferior */
            --sb-text: #333333;
            --sb-grey: #666666;
        }

        body { 
            font-family: 'Roboto', sans-serif; 
            background-color: #ffffff; 
            color: var(--sb-text); 
            text-align: center; 
            padding: 0; margin: 0; 
            height: 100vh;
            display: flex; flex-direction: column;
            user-select: none;
            overflow: hidden; /* Evitar scroll como una app nativa */
        }

        /* HEADER */
        .header { 
            padding: 15px 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid #eee;
        }
        
        .brand-logo { 
            font-family: 'Brush Script MT', cursive; /* Simulando la fuente Crafty */
            color: var(--sb-orange); 
            font-size: 28px; 
            font-weight: bold;
            letter-spacing: -1px;
        }
        
        .btn-disconnect {
            background: none; border: 1px solid var(--sb-orange); 
            color: var(--sb-orange); padding: 5px 15px; 
            border-radius: 4px; font-size: 12px; font-weight: bold;
            cursor: pointer;
        }

        /* PANTALLA DE CONEXIÓN (INICIAL) */
        #screen-connect {
            flex: 1; display: flex; flex-direction: column; 
            justify-content: center; align-items: center;
            padding: 20px;
        }
        
        .connect-circle {
            width: 120px; height: 120px; background: #f0f0f0;
            border-radius: 50%; display: flex; align-items: center; 
            justify-content: center; margin-bottom: 20px;
            font-size: 40px; color: var(--sb-orange);
            cursor: pointer; transition: 0.2s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .connect-circle:active { transform: scale(0.95); background: #e0e0e0; }

        /* PANTALLA PRINCIPAL (APP) */
        #screen-app {
            flex: 1; display: none; flex-direction: column; 
            justify-content: space-between; position: relative;
        }
        .visible { display: flex !important; }

        /* ÁREA CENTRAL */
        .main-display {
            flex: 1; display: flex; flex-direction: column; 
            align-items: center; justify-content: center;
            padding-bottom: 20px;
        }

        .device-image-placeholder {
            width: 100px; height: 160px; 
            background: url('https://www.storz-bickel.com/media/catalog/product/cache/27a9202574e4479dfa93880467770857/c/r/crafty_plus_v2_front_1.png') no-repeat center center;
            background-size: contain;
            margin-bottom: 20px;
            opacity: 0.9;
        }

        /* NÚMEROS DE TEMPERATURA */
        .temp-group { margin-bottom: 20px; position: relative; width: 100%; }
        
        .temp-current { 
            font-size: 42px; font-weight: 300; color: #000; 
            display: flex; justify-content: center; align-items: baseline;
        }
        .temp-current small { font-size: 20px; color: #555; margin-left: 5px; }

        .temp-set-row {
            display: flex; align-items: center; justify-content: center; gap: 20px;
            margin-top: 10px;
        }

        .temp-set { 
            font-size: 56px; font-weight: 500; color: #000; 
            display: flex; justify-content: center; align-items: baseline;
        }
        .temp-set small { font-size: 24px; color: #555; margin-left: 5px; }

        /* BOTONES TRIANGULARES NEGROS */
        .btn-tri {
            width: 50px; height: 50px; background: #333; 
            border-radius: 12px; border: none; color: white;
            font-size: 24px; display: flex; align-items: center; 
            justify-content: center; cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .btn-tri:active { transform: translateY(2px); background: #000; }

        /* BATERÍA */
        .battery-container { width: 60px; height: 25px; background: #ddd; border-radius: 4px; position: relative; margin-top: 20px; }
        .battery-fill { height: 100%; background: #4CAF50; border-radius: 4px; width: 0%; transition: width 0.5s; }
        .battery-cap { position: absolute; right: -4px; top: 7px; width: 4px; height: 10px; background: #ddd; border-top-right-radius: 2px; border-bottom-right-radius: 2px; }
        .batt-text { position: absolute; width: 100%; text-align: center; top: 4px; font-size: 11px; font-weight: bold; color: #333; }

        /* BARRA INFERIOR (NAVEGACIÓN) */
        .bottom-nav {
            background-color: var(--sb-dark-blue);
            height: 60px; width: 100%;
            display: flex; justify-content: space-around; align-items: center;
        }
        .nav-item {
            color: #8faecb; font-size: 10px; text-transform: uppercase;
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            cursor: pointer;
        }
        .nav-item.active { color: #fff; }
        .nav-icon { font-size: 18px; }

        /* MENSAJE DE ESTADO FLOTANTE */
        #statusToast {
            position: absolute; top: 70px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.7); color: white; padding: 5px 15px;
            border-radius: 20px; font-size: 12px; opacity: 0; transition: 0.3s;
        }
    </style>
</head>
<body>

    <div class="header">
        <div class="brand-logo">Crafty+</div>
        <button class="btn-disconnect" onclick="desconectar()">Desconectar</button>
    </div>

    <div id="screen-connect">
        <div class="connect-circle" onclick="conectar()">
            ⚡
        </div>
        <h2 style="color: var(--sb-orange);">Conectar</h2>
        <p style="color: #666; max-width: 250px; font-size: 14px;">
            Asegúrate de que tu dispositivo esté encendido y cerca.
        </p>
    </div>

    <div id="screen-app">
        <div id="statusToast">Actualizando...</div>

        <div class="main-display">
            <div class="device-image-placeholder"></div>

            <div class="temp-current">
                <span id="tempActual">--</span><small>°C</small>
            </div>

            <div class="temp-set-row">
                <button class="btn-tri" onclick="cambiarTemp(-1)">-</button>
                
                <div class="temp-set">
                    <span id="tempTarget">--</span><small>°C</small>
                </div>
                
                <button class="btn-tri" onclick="cambiarTemp(1)">+</button>
            </div>

            <div class="battery-container">
                <div id="batteryFill" class="battery-fill"></div>
                <div class="battery-cap"></div>
                <div id="batteryText" class="batt-text">--%</div>
            </div>
        </div>

        <div class="bottom-nav">
            <div class="nav-item active">
                <span class="nav-icon">ıllı</span>
                Temperatura
            </div>
            <div class="nav-item">
                <span class="nav-icon">☰</span>
                Ajustes
            </div>
            <div class="nav-item">
                <span class="nav-icon">ℹ</span>
                Info
            </div>
        </div>
    </div>

    <script>
        // --- MOTOR V17 (QUEUE SYSTEM) LITE ---
        // Sin catador, sin boost. Solo lo esencial para estabilidad máxima.

        const UUID = {
            MAIN:   '00000001-4c45-4b43-4942-265a524f5453',
            ACTUAL: '00000011-4c45-4b43-4942-265a524f5453',
            TARGET: '00000021-4c45-4b43-4942-265a524f5453',
            BATT:   '00000041-4c45-4b43-4942-265a524f5453',
            ON:     '00000081-4c45-4b43-4942-265a524f5453'
        };

        let device, char = {}, loop;
        let btQueue = Promise.resolve();
        let targetTempLocal = 180; // Memoria local para respuesta instantánea

        function addToQueue(operation) {
            btQueue = btQueue.then(operation).catch(e => console.log(e));
            return btQueue;
        }

        async function conectar() {
            try {
                device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: [UUID.MAIN]
                });
                device.addEventListener('gattserverdisconnected', onDisconnect);
                
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(UUID.MAIN);

                char.actual = await service.getCharacteristic(UUID.ACTUAL);
                char.target = await service.getCharacteristic(UUID.TARGET);
                char.batt   = await service.getCharacteristic(UUID.BATT);
                char.on     = await service.getCharacteristic(UUID.ON);

                // UI Switch
                document.getElementById('screen-connect').style.display = 'none';
                document.getElementById('screen-app').classList.add('visible');

                // Iniciar ciclo de lectura seguro
                loop = setInterval(() => { addToQueue(leerDatos); }, 1500); // 1.5s para menos estrés

            } catch (e) { alert("Error conectando: " + e); }
        }

        function onDisconnect() {
            clearInterval(loop);
            location.reload();
        }

        function desconectar() {
            if(device && device.gatt.connected) device.gatt.disconnect();
            else onDisconnect();
        }

        async function leerDatos() {
            if(!char.actual) return;
            
            // 1. Temp Actual
            const vT = await char.actual.readValue();
            const t = (vT.getUint16(0, true) / 10).toFixed(0); // Sin decimales como la original
            document.getElementById('tempActual').innerText = t;

            // 2. Objetivo (Solo actualizamos si no estamos cambiando manualmente)
            // La original a veces muestra lo que lee
            const vO = await char.target.readValue();
            const obj = (vO.getUint16(0, true) / 10);
            if(obj > 0) {
                targetTempLocal = obj;
                document.getElementById('tempTarget').innerText = obj;
            }

            // 3. Batería
            const vB = await char.batt.readValue();
            const batt = vB.getUint16(0, true);
            document.getElementById('batteryText').innerText = batt + "%";
            document.getElementById('batteryFill').style.width = batt + "%";
            
            // Color batería
            const fill = document.getElementById('batteryFill');
            if(batt > 50) fill.style.background = "#4CAF50";
            else if(batt > 20) fill.style.background = "#FF9800";
            else fill.style.background = "#F44336";
        }

        function cambiarTemp(delta) {
            targetTempLocal += delta;
            if(targetTempLocal > 210) targetTempLocal = 210;
            if(targetTempLocal < 40) targetTempLocal = 40;

            // 1. Cambio Visual Inmediato
            document.getElementById('tempTarget').innerText = targetTempLocal;
            
            // 2. Feedback visual
            mostrarToast("Enviando...");

            // 3. Enviar a la cola
            addToQueue(async () => {
                await write(char.target, targetTempLocal * 10);
                await write(char.on, 1); // Confirmar encendido
                mostrarToast("Guardado");
                setTimeout(() => mostrarToast(""), 1000);
            });
        }

        function mostrarToast(msg) {
            const t = document.getElementById('statusToast');
            t.innerText = msg;
            t.style.opacity = msg ? 1 : 0;
        }

        async function write(c, v) {
            const b = new ArrayBuffer(2);
            new DataView(b).setUint16(0, v, true);
            await c.writeValue(b);
        }
    </script>
</body>
</html>
