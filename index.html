<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crafty+ App Clone</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --sb-orange: #ef7d00;
            --sb-blue: #002855;
            --white: #ffffff;
            --grey-text: #333;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--white);
            color: var(--grey-text);
            margin: 0; padding: 0;
            height: 100vh;
            display: flex; flex-direction: column;
            user-select: none;
            overflow: hidden;
        }

        /* --- HEADER SUPERIOR --- */
        .header {
            height: 50px;
            border-bottom: 1px solid #e0e0e0;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px;
            background: #fff;
        }
        .brand {
            font-family: 'Pacifico', cursive; /* Simulando logo Crafty+ */
            color: var(--sb-orange);
            font-size: 24px;
        }
        .btn-logout {
            border: 1px solid var(--sb-orange);
            color: var(--sb-orange);
            background: transparent;
            padding: 6px 12px;
            font-size: 12px; font-weight: bold;
            border-radius: 4px;
            cursor: pointer;
        }

        /* --- CONTENIDO PRINCIPAL --- */
        .main-content {
            flex: 1;
            display: flex; flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding-top: 10px;
            position: relative;
        }

        .sb-logo-small {
            width: 40px; height: 40px;
            background: #ef7d00; /* Placeholder naranja para logo S&B */
            mask: url('https://www.storz-bickel.com/static/version1673347355/frontend/StorzBickel/default/en_US/images/logo.svg') no-repeat center;
            -webkit-mask: url('https://www.storz-bickel.com/static/version1673347355/frontend/StorzBickel/default/en_US/images/logo.svg') no-repeat center;
            margin-bottom: 5px;
        }
        
        .title-text {
            font-size: 14px; letter-spacing: 1px; font-weight: bold;
            margin-bottom: 10px; text-transform: uppercase;
        }

        .device-img {
            height: 140px; width: auto;
            margin-bottom: 10px;
        }
        
        .device-name {
            font-family: 'Pacifico', cursive;
            font-size: 20px; color: #333;
            margin-bottom: 15px;
        }

        /* --- N√öMEROS Y TRI√ÅNGULOS --- */
        .controls-wrapper {
            display: flex; align-items: center; justify-content: center;
            width: 100%; gap: 15px;
        }

        .btn-tri-black {
            width: 0; height: 0;
            border-style: solid;
            background: transparent;
            cursor: pointer;
            border: none; padding: 20px; /* Area t√°ctil */
        }
        .tri-down {
            border-width: 15px 12px 0 12px;
            border-color: #333 transparent transparent transparent;
        }
        .tri-up {
            border-width: 0 12px 15px 12px;
            border-color: transparent transparent #333 transparent;
        }
        .btn-wrapper {
            background: #eee; border-radius: 10px; 
            width: 50px; height: 50px; display: flex; 
            align-items: center; justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .numbers-col {
            display: flex; flex-direction: column; align-items: center;
            min-width: 100px;
        }
        .num-actual { font-size: 48px; font-weight: 300; line-height: 1; }
        .num-target { font-size: 48px; font-weight: 300; line-height: 1; margin-top: 5px;}
        .degree { font-size: 20px; vertical-align: super; }

        /* BATER√çA */
        .batt-icon {
            width: 120px; height: 30px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 40"><rect x="5" y="5" width="80" height="30" rx="2" stroke="%23555" fill="none" stroke-width="3"/><rect id="fill" x="8" y="8" width="74" height="24" rx="1" fill="%23555"/><rect x="88" y="12" width="5" height="16" fill="%23555"/></svg>') no-repeat center;
            background-size: contain;
            margin-top: 20px;
        }

        /* --- BARRA NARANJA (BOOST / AUMENTAR) --- */
        .orange-bar {
            background-color: var(--sb-orange);
            width: 100%; padding: 10px 0;
            display: flex; justify-content: space-between; align-items: center;
            color: white; font-weight: bold; font-size: 14px;
            margin-top: auto; /* Empujar al fondo */
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        .btn-white-tri {
            width: 40px; height: 40px;
            background: #fff; border-radius: 50%;
            border: none; color: var(--sb-orange);
            font-size: 24px; font-weight: bold;
            margin: 0 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: flex; align-items: center; justify-content: center;
        }

        /* --- BARRA AZUL (NAVEGACI√ìN) --- */
        .nav-bar {
            background-color: var(--sb-blue);
            height: 60px;
            display: flex; justify-content: space-around; align-items: center;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center;
            color: #8daec4; font-size: 9px; text-transform: uppercase;
            font-weight: 600; cursor: pointer;
        }
        .nav-item.active { color: white; }
        .nav-icon { 
            font-size: 20px; margin-bottom: 4px; 
            display: block; height: 24px;
        }

        /* ESTADOS */
        .screen { display: none; height: 100%; flex-direction: column; }
        .visible { display: flex; }
        
        #connect-view { justify-content: center; align-items: center; }
        .big-connect {
            width: 100px; height: 100px; border: 4px solid #eee;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 40px; color: var(--sb-orange); cursor: pointer;
        }

    </style>
</head>
<body>

    <div id="connect-view" class="screen visible">
        <div class="header" style="width:100%; position:absolute; top:0; box-sizing:border-box;">
            <div class="brand">Crafty+</div>
        </div>
        <div class="big-connect" onclick="conectar()">‚ö°</div>
        <p style="color:#999; margin-top:20px;">Toque para conectar</p>
    </div>

    <div id="app-view" class="screen">
        
        <div class="header">
            <div class="brand">Crafty+</div>
            <button class="btn-logout" onclick="desconectar()">Desconectar</button>
        </div>

        <div class="main-content">
            <div style="font-size:12px; font-weight:bold;">WWW.STORZ-BICKEL.COM</div>
            <div class="title-text" style="margin-top:10px;">TEMPERATURA</div>
            
            <img src="https://www.storz-bickel.com/media/catalog/product/cache/27a9202574e4479dfa93880467770857/c/r/crafty_plus_v2_front_1.png" class="device-img">
            
            <div class="device-name">Crafty+</div>

            <div class="controls-wrapper">
                <div class="btn-wrapper" onclick="cambioManual(-1)">
                    <div class="btn-tri-black tri-down"></div>
                </div>

                <div class="numbers-col">
                    <div class="num-actual">
                        <span id="txtActual">--</span><span class="degree">¬∞C</span>
                    </div>
                    <div class="num-target">
                        <span id="txtTarget">--</span><span class="degree">¬∞C</span>
                    </div>
                </div>

                <div class="btn-wrapper" onclick="cambioManual(1)">
                    <div class="btn-tri-black tri-up"></div>
                </div>
            </div>

            <div class="batt-icon">
                </div>
            <div id="txtBatt" style="font-weight:bold; margin-top:5px;">--%</div>
        </div>

        <div class="orange-bar">
            <button class="btn-white-tri" onclick="accionBoost()">‚ö°</button>
            <span>AUMENTAR (+15¬∞C)</span> <button class="btn-white-tri" onclick="accionBoost()">+</button>
        </div>

        <div class="nav-bar">
            <div class="nav-item active">
                <span class="nav-icon">üìä</span>
                Temperatura
            </div>
            <div class="nav-item">
                <span class="nav-icon">‚öô</span>
                Ajustes
            </div>
            <div class="nav-item">
                <span class="nav-icon">üîã</span> Astuto
            </div>
            <div class="nav-item">
                <span class="nav-icon">‚Ñπ</span>
                Info
            </div>
        </div>
    </div>

    <script>
        // --- MOTOR V17 (COLA DE COMANDOS) ---
        // Usamos este motor porque es el m√°s robusto para evitar choques
        
        const UUID = {
            MAIN: '00000001-4c45-4b43-4942-265a524f5453',
            ACT:  '00000011-4c45-4b43-4942-265a524f5453',
            SET:  '00000021-4c45-4b43-4942-265a524f5453',
            BAT:  '00000041-4c45-4b43-4942-265a524f5453',
            ON:   '00000081-4c45-4b43-4942-265a524f5453'
        };

        let dev, char = {}, loop;
        let queue = Promise.resolve();
        let localTarget = 180;

        function addQ(fn) {
            queue = queue.then(fn).catch(e => console.error(e));
            return queue;
        }

        async function conectar() {
            try {
                dev = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: [UUID.MAIN]
                });
                dev.addEventListener('gattserverdisconnected', onDisco);
                const srv = await dev.gatt.connect();
                const svc = await srv.getPrimaryService(UUID.MAIN);

                char.act = await svc.getCharacteristic(UUID.ACT);
                char.set = await svc.getCharacteristic(UUID.SET);
                char.bat = await svc.getCharacteristic(UUID.BAT);
                char.on  = await svc.getCharacteristic(UUID.ON);

                document.getElementById('connect-view').classList.remove('visible');
                document.getElementById('app-view').classList.add('visible');

                loop = setInterval(() => addQ(leer), 1500);

            } catch(e) { alert("Error: " + e); }
        }

        function onDisco() {
            clearInterval(loop);
            location.reload();
        }

        function desconectar() {
            if(dev?.gatt?.connected) dev.gatt.disconnect();
            else onDisconnect();
        }

        async function leer() {
            if(!char.act) return;
            // Temp Actual
            const vA = await char.act.readValue();
            document.getElementById('txtActual').innerText = (vA.getUint16(0, true)/10).toFixed(0);

            // Temp Objetivo (Solo si no estamos editando)
            // En V21 leemos siempre para sincronizar
            const vS = await char.set.readValue();
            const t = vS.getUint16(0, true)/10;
            if(t > 0) {
                localTarget = t;
                document.getElementById('txtTarget').innerText = t.toFixed(0);
            }

            // Bater√≠a
            const vB = await char.bat.readValue();
            const b = vB.getUint16(0, true);
            document.getElementById('txtBatt').innerText = b + "%";
        }

        function cambioManual(delta) {
            localTarget += delta;
            // UI Optimista (Cambio instant√°neo)
            document.getElementById('txtTarget').innerText = localTarget;

            addQ(async () => {
                await write(char.set, localTarget * 10);
                await write(char.on, 1);
            });
        }

        async function accionBoost() {
            localTarget = Math.min(localTarget + 15, 210);
            document.getElementById('txtTarget').innerText = localTarget;
            addQ(async () => {
                await write(char.set, localTarget * 10);
                await write(char.on, 1);
            });
            alert("BOOST ACTIVADO (+15¬∞C)");
        }

        async function write(c, v) {
            const b = new ArrayBuffer(2);
            new DataView(b).setUint16(0, v, true);
            await c.writeValue(b);
        }
    </script>
</body>
</html>
