<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crafty+ Universal Fix</title>
    <style>
        body { font-family: monospace; background: #000; color: #0f0; text-align: center; padding: 20px; }
        .box { border: 1px solid #333; margin: 10px; padding: 10px; border-radius: 10px; }
        button { padding: 15px; width: 100%; font-weight: bold; cursor: pointer; margin-top:5px; border-radius: 5px; border:none;}
        .btn-con { background: #00f; color: white; }
        .btn-hot { background: #f60; color: white; }
        input { font-size: 20px; text-align: center; width: 80px; background: #333; color: white; border: none; padding: 5px;}
    </style>
</head>
<body>
    <h1>üõ†Ô∏è CRAFTY+ DEBUGGER</h1>
    
    <button class="btn-con" id="btn" onclick="conectar()">1. CONECTAR Y ESCANEAR</button>
    <div id="status">Desconectado</div>

    <div id="panel" style="display:none">
        <div class="box">
            TEMP: <span id="tempVal">--</span>¬∞C <br>
            BATT: <span id="battVal">--</span>%
        </div>

        <div class="box">
            <input type="number" id="inputT" value="180">
            <button class="btn-hot" onclick="escribirTemp()">2. FIJAR TEMP (ENCENDER)</button>
        </div>
    </div>

    <div id="logs" style="text-align: left; font-size: 10px; color: #888; margin-top:20px;"></div>

    <script>
        // --- TUS UUIDs (STORZ & BICKEL) ---
        const SB_SERVICE = '00000001-4c45-4b43-4942-265a524f5453'; // Servicio Principal
        const UUID_TEMP  = '00000011-4c45-4b43-4942-265a524f5453'; // Lectura Temp
        const UUID_WRITE = '00000021-4c45-4b43-4942-265a524f5453'; // Escritura Temp

        // --- UUID EST√ÅNDAR (El truco para la bater√≠a) ---
        const BATTERY_SERVICE = '0000180f-0000-1000-8000-00805f9b34fb'; 
        const BATTERY_CHAR    = '00002a19-0000-1000-8000-00805f9b34fb';

        let cache = {};

        function log(m) { 
            console.log(m); 
            document.getElementById('logs').innerHTML += `> ${m}<br>`; 
        }

        async function conectar() {
            try {
                log("Buscando...");
                // IMPORTANTE: Pedimos acceso al servicio S&B Y al servicio de Bater√≠a est√°ndar
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'STORZ' }],
                    optionalServices: [SB_SERVICE, BATTERY_SERVICE] 
                });

                log("Conectando GATT...");
                const server = await device.gatt.connect();
                document.getElementById('btn').style.display = 'none';
                document.getElementById('status').innerText = "Conectado!";
                document.getElementById('panel').style.display = 'block';

                // 1. INTENTAR LEER BATER√çA (EST√ÅNDAR)
                try {
                    const batService = await server.getPrimaryService(BATTERY_SERVICE);
                    const batChar = await batService.getCharacteristic(BATTERY_CHAR);
                    cache['batt'] = batChar;
                    log("Servicio Bater√≠a Est√°ndar: OK");
                    leerBateria();
                } catch(e) {
                    log("‚ö†Ô∏è No se encontr√≥ Bater√≠a Est√°ndar. Buscando en S&B...");
                    // Si falla, intentamos buscarla en el servicio S&B (tu c√≥digo anterior)
                }

                // 2. OBTENER SERVICIO PRINCIPAL S&B
                const sbService = await server.getPrimaryService(SB_SERVICE);
                
                // Temp Actual
                cache['temp'] = await sbService.getCharacteristic(UUID_TEMP);
                setInterval(leerTemp, 2000); // Leer cada 2s

                // Escritura
                cache['write'] = await sbService.getCharacteristic(UUID_WRITE);
                log("Control de Escritura: OK");

            } catch(e) {
                log("ERROR FATAL: " + e);
                alert("Error: " + e);
            }
        }

        async function leerBateria() {
            if(!cache['batt']) return;
            try {
                const val = await cache['batt'].readValue();
                const pct = val.getUint8(0);
                document.getElementById('battVal').innerText = pct;
                log("Bater√≠a actualizada: " + pct + "%");
            } catch(e) { log("Error leyendo bat: " + e); }
        }

        async function leerTemp() {
            if(!cache['temp']) return;
            try {
                const val = await cache['temp'].readValue();
                const c = val.getUint16(0, true) / 10;
                document.getElementById('tempVal').innerText = c.toFixed(1);
            } catch(e) {}
        }

        async function escribirTemp() {
            if(!cache['write']) return alert("No conectado");
            const t = document.getElementById('inputT').value;
            const val = t * 10;
            
            try {
                // Escritura Little Endian
                const buffer = new ArrayBuffer(2);
                new DataView(buffer).setUint16(0, val, true);
                await cache['write'].writeValue(buffer);
                log(`Comando enviado: ${t}¬∞C`);
                alert(`Calentando a ${t}¬∞C`);
            } catch(e) {
                log("Error escritura: " + e);
                alert("Error al escribir. Mira el log.");
            }
        }
    </script>
</body>
</html>
