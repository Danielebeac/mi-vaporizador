<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S&B LABORATORY</title>
    <style>
        body { font-family: monospace; background-color: #111; color: #fff; text-align: center; padding: 20px; }
        h2 { color: #ffff00; }
        .card { background: #222; padding: 20px; border-radius: 10px; border: 1px solid #444; margin: 10px auto; max-width: 400px; }
        
        button { 
            width: 100%; padding: 15px; margin: 5px 0; font-size: 16px; font-weight: bold; cursor: pointer; border: none; border-radius: 5px; 
        }
        .btn-con { background: #0088ff; color: white; }
        .btn-exp { background: #333; color: #aaa; border: 1px solid #555; text-align: left; padding-left: 20px;}
        .btn-exp:active { background: #fff; color: #000; }

        .log-box { height: 150px; overflow-y: scroll; background: #000; border: 1px solid #333; text-align: left; padding: 10px; font-size: 12px; color: #0f0; margin-top: 20px;}
    </style>
</head>
<body>

    <h2>üß™ LABORATORIO CRAFTY+</h2>
    
    <div id="panel-connect">
        <button class="btn-con" onclick="conectar()">1. INICIAR EXPERIMENTO</button>
    </div>

    <div id="panel-test" style="display:none;">
        <div class="card">
            <h3>PRUEBA DE ENCENDIDO</h3>
            <p>Presiona uno por uno. Si vibra o enciende LED rojo, ¬°BINGO!</p>
            
            <button class="btn-exp" onclick="probar('TARGET', 1800)">üî¥ BOT√ìN A (Target 180¬∞C)</button>
            <button class="btn-exp" onclick="probar('81', 1)">üîµ BOT√ìN B (UUID ...81)</button>
            <button class="btn-exp" onclick="probar('91', 1)">üü£ BOT√ìN C (UUID ...91)</button>
            <button class="btn-exp" onclick="probar('A1', 1)">üü° BOT√ìN D (UUID ...A1)</button>
            <button class="btn-exp" onclick="probar('B1', 1)">‚ö™ BOT√ìN E (UUID ...B1)</button>
            <hr>
            <button class="btn-exp" style="color:red" onclick="probar('TARGET', 0)">‚ùå APAGAR TODO (Reset)</button>
        </div>
        <p>Estado: <span id="status">Esperando...</span></p>
    </div>

    <div id="logs" class="log-box">Log del sistema...</div>

    <script>
        // UUIDS CONSTANTES
        const SUFFIX = '-4c45-4b43-4942-265a524f5453';
        const SERVICE = '00000001' + SUFFIX;

        // MAPA DE PUERTAS
        const UUIDS = {
            'TARGET': '00000021' + SUFFIX,
            '81':     '00000081' + SUFFIX,
            '91':     '00000091' + SUFFIX,
            'A1':     '000000a1' + SUFFIX,
            'B1':     '000000b1' + SUFFIX
        };

        let deviceCache = null;
        let characteristics = {};

        function log(msg) {
            const l = document.getElementById('logs');
            l.innerHTML = `> ${msg}<br>` + l.innerHTML;
        }

        async function conectar() {
            try {
                log("Buscando dispositivo...");
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'STORZ' }],
                    optionalServices: [SERVICE]
                });

                log("Conectando...");
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE);
                
                log("Obteniendo accesos de escritura...");
                
                // Intentamos conectar con TODAS las puertas posibles
                for (let key in UUIDS) {
                    try {
                        characteristics[key] = await service.getCharacteristic(UUIDS[key]);
                        log(`‚úÖ Acceso a UUID ...${key} OK`);
                    } catch (e) {
                        log(`‚ö†Ô∏è No se pudo acceder a ...${key}`);
                    }
                }

                document.getElementById('panel-connect').style.display = 'none';
                document.getElementById('panel-test').style.display = 'block';
                document.getElementById('status').innerText = "CONECTADO - Listo para probar";

            } catch (e) {
                log("Error: " + e);
                alert("Error: " + e);
            }
        }

        async function probar(key, valor) {
            if (!characteristics[key]) return alert("Esa caracter√≠stica no est√° disponible");

            try {
                // Preparamos el dato (Little Endian)
                const buffer = new ArrayBuffer(2);
                new DataView(buffer).setUint16(0, valor, true);
                
                await characteristics[key].writeValue(buffer);
                
                log(`‚ö° ENVIADO a [${key}]: Valor ${valor}`);
                document.getElementById('status').innerText = `√öltimo intento: Bot√≥n ${key}`;
                
            } catch (e) {
                log(`‚ùå Error en bot√≥n ${key}: ${e}`);
            }
        }
    </script>
</body>
</html>
