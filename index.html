<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crafty+ Master v2.0</title>
    <style>
        body { font-family: 'Courier New', monospace; background-color: #050505; color: #00ffcc; text-align: center; padding: 20px; margin: 0; }
        h1 { text-shadow: 0 0 10px #00ffcc; margin-bottom: 5px; font-size: 1.5rem; }
        .status { color: #888; font-size: 0.8rem; margin-bottom: 20px; }
        
        .card { background: #1a1a1a; border: 1px solid #333; border-radius: 12px; padding: 15px; margin: 15px auto; max-width: 320px; box-shadow: 0 4px 15px rgba(0,255,204,0.1); }
        .value { font-size: 48px; font-weight: bold; color: #fff; margin: 10px 0; }
        .sub-value { font-size: 14px; color: #aaa; }

        button { border: none; padding: 15px; font-size: 16px; font-weight: bold; border-radius: 8px; cursor: pointer; width: 100%; margin-top: 10px; transition: transform 0.1s; }
        button:active { transform: scale(0.98); }
        .btn-connect { background: linear-gradient(45deg, #00b09b, #96c93d); color: #000; }
        .btn-set { background: #e67e22; color: white; }
        .btn-cata { background: linear-gradient(45deg, #8e44ad, #c0392b); color: white; box-shadow: 0 0 10px #8e44ad; }
        .btn-off { background: #444; color: #fff; }

        input { font-size: 24px; padding: 5px; width: 80px; text-align: center; background: #222; border: 1px solid #444; color: white; border-radius: 5px; }
        
        #logs { font-size: 10px; color: #555; text-align: left; margin-top: 30px; border-top: 1px solid #333; padding: 10px; height: 100px; overflow-y: scroll; background: #000; }
    </style>
</head>
<body>

    <h1>üå´Ô∏è CRAFTY+ MASTER</h1>
    <div id="statusText" class="status">Desconectado</div>

    <div id="connectPanel">
        <button class="btn-connect" onclick="connect()">üîå CONECTAR</button>
    </div>

    <div id="app" style="display:none;">
        
        <div class="card" style="border-color: #8e44ad;">
            <small>üç∑ MODO CATADOR</small>
            <div id="cataStatus" class="sub-value">Listo para iniciar</div>
            <button class="btn-cata" onclick="startCata()">‚ñ∂ INICIAR SESI√ìN</button>
            <p style="font-size:10px; color:#aaa;">Sube 5¬∞C cada 45s (Inicio: 175¬∞C)</p>
        </div>

        <div class="card">
            <small>TEMPERATURA ACTUAL</small>
            <div id="tempDisplay" class="value">--.-</div>
            <small>OBJETIVO: <span id="targetDisplay">--</span>¬∞C</small>
        </div>

        <div class="card">
            <small>CONTROL MANUAL</small>
            <br><br>
            <input type="number" id="targetInput" value="180"> ¬∞C
            <button class="btn-set" onclick="setTemperature()">FIJAR TEMPERATURA</button>
            <button class="btn-off" onclick="setTemperature(0)">DETENER (OFF)</button>
        </div>

        <div class="card">
            <small>BATER√çA</small>
            <div id="batDisplay" class="value" style="font-size:24px;">--%</div>
        </div>
    </div>

    <div id="logs">Esperando conexi√≥n...</div>

    <script>
        // --- UUIDS DESCUBIERTOS EN TU ESC√ÅNER ---
        const SUFFIX = '-4c45-4b43-4942-265a524f5453';
        const SERVICE_MAIN = '00000001' + SUFFIX; 
        
        // Mapeo corregido seg√∫n tu captura:
        const UUID_TEMP_ACTUAL = '00000011' + SUFFIX; // 28.2 C -> Correcto
        const UUID_TEMP_OBJET  = '00000021' + SUFFIX; // 185.0 C -> WRITE -> Correcto
        const UUID_BATERIA     = '00000041' + SUFFIX; // Valor 99 -> BATER√çA CONFIRMADA

        let deviceCache = null;
        let charTemp = null;
        let charTarget = null;
        let charBat = null;
        let loopId = null;

        function log(msg) {
            const l = document.getElementById('logs');
            l.innerHTML = `> ${msg}<br>` + l.innerHTML;
        }

        async function connect() {
            try {
                log("Buscando Crafty/Mighty...");
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'STORZ' }],
                    optionalServices: [SERVICE_MAIN]
                });

                deviceCache = device;
                document.getElementById('statusText').innerText = "Conectando...";
                
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_MAIN);
                
                log("Servicio conectado. Obteniendo caracter√≠sticas...");

                // 1. Temperatura Actual
                try {
                    charTemp = await service.getCharacteristic(UUID_TEMP_ACTUAL);
                    await charTemp.startNotifications();
                    charTemp.addEventListener('characteristicvaluechanged', (e) => {
                        const val = e.target.value.getUint16(0, true);
                        document.getElementById('tempDisplay').innerText = (val / 10).toFixed(1) + "¬∞C";
                    });
                    log("‚úÖ Lectura Temp OK");
                } catch(e) { log("Error Temp: " + e); }

                // 2. Objetivo (Escritura)
                try {
                    charTarget = await service.getCharacteristic(UUID_TEMP_OBJET);
                    log("‚úÖ Control Temp OK");
                } catch(e) { log("Error Control: " + e); }

                // 3. Bater√≠a (CORREGIDO: UUID 41)
                try {
                    charBat = await service.getCharacteristic(UUID_BATERIA);
                    leerBateria(); // Leer inmediatamente
                    log("‚úÖ Bater√≠a Encontrada (UUID 41)");
                } catch(e) { log("Error Bater√≠a: " + e); }

                // UI
                document.getElementById('connectPanel').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                document.getElementById('statusText').innerText = "üü¢ CONECTADO: " + device.name;

                // Iniciar bucle para refrescar bater√≠a cada 10s
                loopId = setInterval(leerBateria, 10000);

            } catch (err) {
                alert("Error: " + err);
                log("Fallo: " + err);
            }
        }

        async function leerBateria() {
            if (!charBat) return;
            try {
                const val = await charBat.readValue();
                // Tu captura muestra Int16: 99. Leemos como Uint16.
                const nivel = val.getUint16(0, true); 
                document.getElementById('batDisplay').innerText = nivel + "%";
            } catch(e) { console.log(e); }
        }

        async function setTemperature(val = null) {
            if (!charTarget) return alert("No hay control de temperatura");
            
            const temp = val !== null ? val : parseInt(document.getElementById('targetInput').value);
            
            // Actualizar visualmente el objetivo
            document.getElementById('targetDisplay').innerText = temp > 0 ? temp : "OFF";
            if(temp > 0) document.getElementById('targetInput').value = temp;

            try {
                // S&B usa d√©cimas de grado (180 C = 1800)
                const valorEnviar = temp * 10;
                
                // Preparar buffer Little Endian
                const buffer = new ArrayBuffer(2);
                new DataView(buffer).setUint16(0, valorEnviar, true);

                await charTarget.writeValue(buffer);
                log(`Orden enviada: ${temp}¬∞C`);
                
            } catch (e) {
                log("Error al escribir: " + e);
                alert("Error de comunicaci√≥n con el vape");
            }
        }

        // --- MODO CATADOR ---
        async function startCata() {
            const pasos = [175, 180, 185, 190, 195];
            const btn = document.querySelector('.btn-cata');
            const status = document.getElementById('cataStatus');
            
            btn.disabled = true;
            btn.style.background = "#555";
            
            for (let i = 0; i < pasos.length; i++) {
                const t = pasos[i];
                status.innerText = `Paso ${i+1}/5: Calentando a ${t}¬∞C...`;
                await setTemperature(t);
                
                // Cuenta atr√°s visual de 45s
                for(let s=45; s>0; s--) {
                    btn.innerText = `‚è≥ ${s}s para siguiente nivel`;
                    await new Promise(r => setTimeout(r, 1000));
                }
            }

            status.innerText = "¬°Sesi√≥n Completada!";
            btn.innerText = "‚ñ∂ REINICIAR SESI√ìN";
            btn.disabled = false;
            btn.style.background = "linear-gradient(45deg, #8e44ad, #c0392b)";
            alert("Tu sesi√≥n ha terminado. ¬°Disfruta!");
        }
    </script>
</body>
</html>
