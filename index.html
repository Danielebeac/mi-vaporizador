<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Crafty+ / Mighty+</title>
    <style>
        /* ESTILOS: Diseño oscuro similar a tu app */
        body {
            background-color: #0d0d0d;
            color: #ffffff;
            font-family: 'Courier New', Courier, monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
        }

        .card {
            background-color: #1a1a1a;
            border: 1px solid #333;
            border-radius: 15px;
            padding: 20px;
            margin: 10px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.5);
        }

        h2 {
            color: #00ffcc; /* Color verdoso de tus textos */
            font-size: 16px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .big-text {
            font-size: 48px;
            font-weight: bold;
            color: white;
        }

        .status-label {
            color: #888;
            font-size: 14px;
        }

        /* Botón Naranja Principal */
        .btn-action {
            background-color: #e67e22; /* Naranja */
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }

        .btn-action:active {
            background-color: #d35400;
        }

        /* Botón Conectar */
        .btn-connect {
            background: linear-gradient(90deg, #8e44ad, #c0392b);
            color: white;
            border: none;
            padding: 15px;
            width: 100%;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 20px;
        }

        input[type="number"] {
            background-color: #333;
            color: white;
            border: 1px solid #555;
            padding: 10px;
            font-size: 24px;
            width: 80px;
            text-align: center;
            border-radius: 5px;
        }
    </style>
</head>
<body>

    <div class="card">
        <button id="btnConnect" class="btn-connect" onclick="conectarDispositivo()">
            ▶ INICIAR CONEXIÓN
        </button>
        <div id="statusConnection" class="status-label">Desconectado</div>
    </div>

    <div class="card">
        <h2>Temperatura Actual</h2>
        <div class="big-text"><span id="tempActual">--</span>°C</div>
    </div>

    <div class="card">
        <h2>Control Manual</h2>
        <div style="margin-bottom: 15px;">
            <input type="number" id="inputTemp" value="180"> °C
        </div>
        <button class="btn-action" onclick="fijarTemperatura()">
            FIJAR / CALENTAR
        </button>
        <br><br>
        <button class="btn-action" style="background-color: #444;" onclick="detenerCalentamiento()">
            DETENER (OFF)
        </button>
    </div>

    <div class="card">
        <h2>Batería</h2>
        <div class="big-text"><span id="batteryLevel">--</span>%</div>
    </div>

    <script>
        // --- CONSTANTES DE UUID (STORZ & BICKEL) ---
        const SERVICE_UUID = '00000001-5354-4f52-5a26-4249434b454c';
        
        // Características Específicas
        const CHAR_TEMP_ACTUAL  = '00000011-5354-4f52-5a26-4249434b454c'; // Lectura (Read/Notify)
        const CHAR_TEMP_TARGET  = '00000021-5354-4f52-5a26-4249434b454c'; // Escritura (Write)
        const CHAR_BATTERY      = '00000003-5354-4f52-5a26-4249434b454c'; // Lectura (Read)

        // Variables globales para guardar las referencias
        let deviceCache = null;
        let charTargetTemp = null; // Aquí escribiremos para "Encender"

        // 1. FUNCIÓN PARA CONECTAR
        async function conectarDispositivo() {
            try {
                console.log('Buscando dispositivos Storz & Bickel...');
                
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [SERVICE_UUID] }]
                });

                deviceCache = device;
                document.getElementById('statusConnection').innerText = "Conectando...";
                
                // Conectar al servidor GATT
                const server = await device.gatt.connect();
                console.log('Conectado al servidor GATT');

                // Obtener el Servicio Principal
                const service = await server.getPrimaryService(SERVICE_UUID);

                // --- A. OBTENER CARACTERÍSTICA DE BATERÍA (Solución a tu error de lectura) ---
                try {
                    const batteryChar = await service.getCharacteristic(CHAR_BATTERY);
                    const value = await batteryChar.readValue();
                    // La batería suele venir en el primer byte o como entero corto
                    const porcentaje = value.getUint16(0, true); // true = Little Endian
                    document.getElementById('batteryLevel').innerText = porcentaje;
                    console.log("Batería detectada:", porcentaje);
                } catch (err) {
                    console.error("Error leyendo batería:", err);
                    document.getElementById('batteryLevel').innerText = "Err";
                }

                // --- B. OBTENER TEMPERATURA ACTUAL (Para mostrar en pantalla) ---
                try {
                    const tempChar = await service.getCharacteristic(CHAR_TEMP_ACTUAL);
                    await tempChar.startNotifications();
                    tempChar.addEventListener('characteristicvaluechanged', (event) => {
                        const val = event.target.value;
                        const temp = val.getUint16(0, true) / 10; // Dividir por 10
                        document.getElementById('tempActual').innerText = temp.toFixed(1);
                    });
                    console.log("Notificaciones de temperatura activadas");
                } catch (err) {
                    console.error("Error leyendo temp actual:", err);
                }

                // --- C. OBTENER CONTROL (Para el botón de encendido) ---
                charTargetTemp = await service.getCharacteristic(CHAR_TEMP_TARGET);
                
                document.getElementById('statusConnection').innerText = "CONECTADO: " + device.name;
                document.getElementById('btnConnect').style.display = 'none';

            } catch (error) {
                console.error('Error de conexión:', error);
                alert('No se pudo conectar. Asegúrate de usar Chrome/Bluefy y tener Bluetooth activo.');
            }
        }

        // 2. FUNCIÓN PARA "ENCENDER" (Fijar Temperatura)
        async function fijarTemperatura() {
            if (!charTargetTemp) {
                alert("¡Primero conecta el dispositivo!");
                return;
            }

            const grados = document.getElementById('inputTemp').value;
            
            try {
                // El truco: Multiplicar por 10 y enviar como Uint16 Little Endian
                const valorEnviar = grados * 10;
                
                const buffer = new ArrayBuffer(2);
                const view = new DataView(buffer);
                view.setUint16(0, valorEnviar, true); // Little Endian es CLAVE

                await charTargetTemp.writeValue(buffer);
                
                console.log(`Comando enviado: Calentar a ${grados}°C`);
                alert(`Iniciando calentamiento a ${grados}°C`);
                
            } catch (error) {
                console.error("Error al enviar temperatura:", error);
                alert("Error al intentar calentar.");
            }
        }

        // 3. FUNCIÓN PARA DETENER
        async function detenerCalentamiento() {
            if (!charTargetTemp) return;
            
            try {
                // Enviar 0 detiene el calentador
                const buffer = new ArrayBuffer(2);
                const view = new DataView(buffer);
                view.setUint16(0, 0, true); 

                await charTargetTemp.writeValue(buffer);
                alert("Calentamiento detenido (Standby)");
            } catch (error) {
                console.error(error);
            }
        }
    </script>
</body>
</html>
