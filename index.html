<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRAFTY+ ULTIMATE</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #000; color: #fff; text-align: center; padding: 20px; margin: 0; user-select: none; }
        
        /* HEADER & ESTADO */
        .header { display: flex; justify-content: space-between; align-items: center; max-width: 400px; margin: 0 auto 20px auto; padding: 0 10px;}
        h2 { margin: 0; font-size: 18px; color: #ccc; letter-spacing: 1px; }
        
        .badge { padding: 5px 12px; border-radius: 20px; font-weight: bold; font-size: 12px; text-transform: uppercase; }
        .badge-no { background-color: #333; color: #777; border: 1px solid #555; }
        .badge-ok { background-color: #00ff00; color: #000; box-shadow: 0 0 10px #00ff00; }

        /* TARJETAS */
        .card { background: #121212; border: 1px solid #333; border-radius: 20px; padding: 25px; margin: 15px auto; max-width: 360px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); position: relative; overflow: hidden; }
        
        /* MONITOR TEMPERATURA */
        .temp-display { font-size: 64px; font-weight: 200; color: #fff; margin: 10px 0; letter-spacing: -2px; }
        .temp-unit { font-size: 24px; color: #666; font-weight: normal;}
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; border-top: 1px solid #222; padding-top: 15px; }
        .stat-label { font-size: 10px; color: #666; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
        .stat-val { font-size: 18px; font-weight: bold; }
        
        /* CONTROLES */
        .control-group { display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 20px; }
        input[type="number"] { background: #1a1a1a; border: 1px solid #444; color: #fff; font-size: 28px; padding: 10px; width: 80px; text-align: center; border-radius: 12px; outline: none; transition: 0.3s; }
        input:focus { border-color: #00e5ff; box-shadow: 0 0 10px rgba(0,229,255,0.2); }

        /* BOTONES */
        button { border: none; padding: 16px; font-size: 15px; font-weight: 700; border-radius: 12px; cursor: pointer; width: 100%; margin-top: 10px; transition: all 0.2s ease; position: relative; overflow: hidden; }
        button:active { transform: scale(0.96); }

        .btn-connect { background: #fff; color: #000; font-size: 16px; }
        
        /* Botones de Acci√≥n */
        .btn-on { background: linear-gradient(135deg, #ff7e5f, #feb47b); color: #000; font-size: 18px; }
        .btn-off { background: #2a2a2a; color: #fff; }
        .btn-boost { background: linear-gradient(135deg, #FFD700, #ffaa00); color: #000; }
        
        /* Modo Catador */
        .btn-cata { background: linear-gradient(135deg, #8e2de2, #4a00e0); color: white; }
        .cata-active { animation: pulse 2s infinite; border: 1px solid #fff; }

        .btn-disconnect { background: transparent; border: 1px solid #ff3333; color: #ff3333; margin-top: 30px; padding: 10px; font-size: 12px; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(138, 43, 226, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(138, 43, 226, 0); } 100% { box-shadow: 0 0 0 0 rgba(138, 43, 226, 0); } }

        /* LOGS OCULTOS */
        #logs { display: none; } 
    </style>
</head>
<body>

    <div class="header">
        <h2>CRAFTY+ <span style="color:#00e5ff">ULTIMATE</span></h2>
        <span id="statusBadge" class="badge badge-no">OFF</span>
    </div>

    <div id="screen-connect">
        <div class="card" style="padding: 40px 20px;">
            <div style="font-size: 40px; margin-bottom: 20px;">üîå</div>
            <p style="color:#888; margin-bottom: 30px;">Conecta tu dispositivo para acceder al panel de control avanzado.</p>
            <button class="btn-connect" onclick="conectar()">INICIAR CONEXI√ìN</button>
        </div>
    </div>

    <div id="screen-app" style="display:none;">
        
        <div class="card">
            <div class="temp-display">
                <span id="tempActual">--</span><span class="temp-unit">¬∞C</span>
            </div>
            
            <div class="stats-grid">
                <div>
                    <div class="stat-label">Objetivo</div>
                    <div id="tempTarget" class="stat-val" style="color: #ff9966;">--</div>
                </div>
                <div>
                    <div class="stat-label">Bater√≠a</div>
                    <div id="batteryLevel" class="stat-val" style="color: #00ff00;">--</div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="stat-label" style="text-align: left; margin-bottom: 15px;">MODOS INTELIGENTES</div>
            
            <button id="btnCata" class="btn-cata" onclick="iniciarModoCatador()">
                üç∑ MODO CATADOR (AUTO)
            </button>
            <p id="cataInfo" style="font-size: 10px; color: #888; margin-top: 5px;">Sube progresivamente: 175¬∞C ‚Æï 185¬∞C ‚Æï 195¬∞C</p>

            <button class="btn-boost" onclick="activarBoost()">
                ‚ö° BOOST (+15¬∞C)
            </button>
        </div>

        <div class="card">
            <div class="stat-label" style="text-align: left; margin-bottom: 15px;">CONTROL MANUAL</div>
            
            <div class="control-group">
                <button style="width: 40px; background: #222; color: #fff;" onclick="ajustar(-1)">-</button>
                <input type="number" id="inputTemp" value="180">
                <button style="width: 40px; background: #222; color: #fff;" onclick="ajustar(1)">+</button>
            </div>
            
            <button class="btn-on" onclick="encender()">ENCENDER üî•</button>
            <button class="btn-off" onclick="apagar()">DETENER ‚ùÑÔ∏è</button>

            <button class="btn-disconnect" onclick="desconectar()">DESCONECTAR DISPOSITIVO</button>
        </div>
    </div>

    <script>
        // --- CONSTANTES ---
        const SUFFIX = '-4c45-4b43-4942-265a524f5453';
        const SERVICE_MAIN = '00000001' + SUFFIX;
        
        const UUID = {
            TEMP_ACTUAL: '00000011' + SUFFIX,
            TEMP_TARGET: '00000021' + SUFFIX,
            BATERIA:     '00000041' + SUFFIX,
            ON:          '00000081' + SUFFIX, // Confirmado
            OFF:         '00000091' + SUFFIX  // Confirmado
        };

        let deviceCache = null;
        let char = {}; // Cache de caracter√≠sticas
        let loopInterval = null;
        let cataInterval = null;

        // --- CONEXI√ìN ---
        async function conectar() {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'STORZ' }],
                    optionalServices: [SERVICE_MAIN]
                });

                deviceCache = device;
                // Detectar desconexi√≥n f√≠sica (por si apagan el bluetooth del cel)
                device.addEventListener('gattserverdisconnected', onDisconnect);

                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_MAIN);
                
                // Mapear todo
                char.temp   = await service.getCharacteristic(UUID.TEMP_ACTUAL);
                char.target = await service.getCharacteristic(UUID.TEMP_TARGET);
                char.batt   = await service.getCharacteristic(UUID.BATERIA);
                char.on     = await service.getCharacteristic(UUID.ON);
                char.off    = await service.getCharacteristic(UUID.OFF);

                // UI
                document.getElementById('screen-connect').style.display = 'none';
                document.getElementById('screen-app').style.display = 'block';
                document.getElementById('statusBadge').innerText = "ONLINE";
                document.getElementById('statusBadge').className = "badge badge-ok";

                // Iniciar polling
                loopInterval = setInterval(leerDatos, 1000);

            } catch (error) {
                alert("Error: " + error);
            }
        }

        function desconectar() {
            if (deviceCache && deviceCache.gatt.connected) {
                deviceCache.gatt.disconnect();
            } else {
                onDisconnect();
            }
        }

        function onDisconnect() {
            clearInterval(loopInterval);
            detenerCata(); // Parar modo catador si estaba activo
            document.getElementById('screen-connect').style.display = 'block';
            document.getElementById('screen-app').style.display = 'none';
            document.getElementById('statusBadge').innerText = "OFF";
            document.getElementById('statusBadge').className = "badge badge-no";
            deviceCache = null;
        }

        // --- LECTURA DE DATOS ---
        async function leerDatos() {
            if (!char.temp) return;
            try {
                // Temperatura
                const vT = await char.temp.readValue();
                const t = vT.getUint16(0, true) / 10;
                document.getElementById('tempActual').innerText = t.toFixed(1);

                // Bater√≠a
                const vB = await char.batt.readValue();
                const b = vB.getUint16(0, true);
                document.getElementById('batteryLevel').innerText = b + "%";
                
                // Objetivo
                const vO = await char.target.readValue();
                const o = vO.getUint16(0, true) / 10;
                document.getElementById('tempTarget').innerText = o > 0 ? o + "¬∞C" : "OFF";

            } catch (e) { console.log(e); }
        }

        // --- CONTROL MANUAL ---
        function ajustar(delta) {
            const input = document.getElementById('inputTemp');
            let val = parseInt(input.value) + delta;
            if (val > 210) val = 210;
            if (val < 40) val = 40;
            input.value = val;
        }

        async function encender(gradosOverride = null) {
            if (!char.on) return;
            const grados = gradosOverride || document.getElementById('inputTemp').value;
            
            try {
                // 1. Escribir Target
                await escribir(char.target, grados * 10);
                // 2. Presionar ON
                await escribir(char.on, 1);
                
                // Feedback visual sutil (vibraci√≥n en m√≥viles)
                if(navigator.vibrate) navigator.vibrate(50);
            } catch (e) { alert("Error enviando comando"); }
        }

        async function apagar() {
            detenerCata(); // Cancelar modos autom√°ticos si est√°n corriendo
            if (!char.off) return;
            try {
                await escribir(char.off, 1);
                await escribir(char.target, 0); // Opcional, para limpiar pantalla
            } catch (e) {}
        }

        // --- MODO BOOST ---
        async function activarBoost() {
            // Lee la temperatura actual del input y suma 15
            let actual = parseInt(document.getElementById('inputTemp').value);
            let boostTemp = actual + 15;
            if (boostTemp > 210) boostTemp = 210; // L√≠mite de seguridad
            
            document.getElementById('inputTemp').value = boostTemp;
            await encender(boostTemp);
            alert(`üöÄ BOOST ACTIVADO: ${boostTemp}¬∞C`);
        }

        // --- MODO CATADOR (Sesi√≥n Autom√°tica) ---
        async function iniciarModoCatador() {
            const pasos = [175, 185, 195];
            const tiempoPorPaso = 45; // segundos
            let pasoActual = 0;
            const btn = document.getElementById('btnCata');
            const info = document.getElementById('cataInfo');

            btn.classList.add('cata-active');
            btn.innerText = "DETENER MODO CATADOR";
            btn.onclick = detenerCata; // Cambiar funci√≥n del bot√≥n

            // Funci√≥n interna del ciclo
            const ciclo = async () => {
                if (pasoActual >= pasos.length) {
                    detenerCata();
                    alert("üç∑ Sesi√≥n de Cata Finalizada");
                    return;
                }

                const temp = pasos[pasoActual];
                info.innerText = `Paso ${pasoActual + 1}/3: Disfrutando a ${temp}¬∞C...`;
                document.getElementById('inputTemp').value = temp;
                
                await encender(temp); // Enviar orden

                // Esperar para el siguiente paso
                pasoActual++;
                cataInterval = setTimeout(ciclo, tiempoPorPaso * 1000);
            };

            // Iniciar primer paso
            ciclo();
        }

        function detenerCata() {
            clearTimeout(cataInterval);
            cataInterval = null;
            const btn = document.getElementById('btnCata');
            btn.classList.remove('cata-active');
            btn.innerText = "üç∑ MODO CATADOR (AUTO)";
            btn.onclick = iniciarModoCatador; // Restaurar funci√≥n
            document.getElementById('cataInfo').innerText = "Sube progresivamente: 175¬∞C ‚Æï 185¬∞C ‚Æï 195¬∞C";
        }

        // --- UTILIDADES ---
        async function escribir(caracteristica, valor) {
            const buffer = new ArrayBuffer(2);
            new DataView(buffer).setUint16(0, valor, true);
            await caracteristica.writeValue(buffer);
        }
    </script>
</body>
</html>
