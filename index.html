<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crafty+ Master Control</title>
    <style>
        body { font-family: 'Courier New', monospace; background-color: #050505; color: #00ffcc; text-align: center; padding: 20px; margin: 0; }
        h1 { text-shadow: 0 0 10px #00ffcc; margin-bottom: 5px; font-size: 1.5rem; }
        .status { color: #888; font-size: 0.8rem; margin-bottom: 20px; }
        
        /* Tarjetas */
        .card { background: #1a1a1a; border: 1px solid #333; border-radius: 12px; padding: 15px; margin: 15px auto; max-width: 320px; box-shadow: 0 4px 15px rgba(0,255,204,0.1); }
        .value { font-size: 48px; font-weight: bold; color: #fff; margin: 10px 0; }
        .sub-value { font-size: 14px; color: #aaa; }

        /* Botones */
        button { border: none; padding: 15px; font-size: 16px; font-weight: bold; border-radius: 8px; cursor: pointer; width: 100%; margin-top: 10px; transition: transform 0.1s; }
        button:active { transform: scale(0.98); }
        .btn-connect { background: linear-gradient(45deg, #00b09b, #96c93d); color: #000; }
        .btn-set { background: #e67e22; color: white; }
        .btn-cata { background: linear-gradient(45deg, #8e44ad, #c0392b); color: white; box-shadow: 0 0 10px #8e44ad; }
        .btn-debug { background: #333; color: #888; font-size: 12px; padding: 10px; }

        input { font-size: 24px; padding: 5px; width: 80px; text-align: center; background: #222; border: 1px solid #444; color: white; border-radius: 5px; }
        
        /* Logs */
        #logs { font-size: 10px; color: #555; text-align: left; margin-top: 30px; border-top: 1px solid #333; padding: 10px; height: 150px; overflow-y: scroll; background: #000; }
    </style>
</head>
<body>

    <h1>üå´Ô∏è CRAFTY+ MASTER</h1>
    <div id="statusText" class="status">Desconectado</div>

    <div id="connectPanel">
        <button class="btn-connect" onclick="connect()">üîå CONECTAR DISPOSITIVO</button>
    </div>

    <div id="app" style="display:none;">
        
        <div class="card" style="border-color: #8e44ad;">
            <small>üç∑ MODO CATADOR</small>
            <div id="cataStatus" class="sub-value">Listo para iniciar</div>
            <button class="btn-cata" onclick="startCata()">‚ñ∂ INICIAR SESI√ìN</button>
            <p style="font-size:10px; color:#aaa;">Inicia en 175¬∞C y sube cada 45s</p>
        </div>

        <div class="card">
            <small>TEMPERATURA ACTUAL</small>
            <div id="tempDisplay" class="value">--.-</div>
            <small>OBJETIVO: <span id="targetDisplay">--</span>¬∞C</small>
        </div>

        <div class="card">
            <small>CONTROL MANUAL</small>
            <br><br>
            <input type="number" id="targetInput" value="180"> ¬∞C
            <button class="btn-set" onclick="setTemperature()">FIJAR TEMPERATURA</button>
        </div>

        <div class="card">
            <small>DIAGN√ìSTICO BATER√çA</small>
            <div id="batDisplay" class="value" style="font-size:24px;">--%</div>
            <button class="btn-debug" onclick="scanServices()">üîç ESCANEAR UUIDs</button>
        </div>
    </div>

    <div id="logs"></div>

    <script>
        // CONFIGURACI√ìN
        // UUIDs Invertidos (Modo Espejo)
        const SUFFIX = '-4c45-4b43-4942-265a524f5453';
        const SERVICE_MAIN = '00000001' + SUFFIX; 
        const CHAR_TEMP    = '00000011' + SUFFIX; 
        const CHAR_TARGET  = '00000021' + SUFFIX; 
        
        // Variables globales
        let deviceCache = null;
        let serverCache = null;
        let cache = {};
        let pollingInterval;

        function log(msg) {
            const logDiv = document.getElementById('logs');
            logDiv.innerHTML = `> ${msg}<br>` + logDiv.innerHTML;
        }

        async function connect() {
            try {
                log("Solicitando conexi√≥n...");
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'STORZ' }], 
                    optionalServices: [SERVICE_MAIN] 
                });

                deviceCache = device;
                document.getElementById('statusText').innerText = "Conectado a: " + device.name;
                
                const server = await device.gatt.connect();
                serverCache = server; // Guardamos para escanear despu√©s
                
                const service = await server.getPrimaryService(SERVICE_MAIN);
                log("Servicio principal OK");

                // Conectar caracter√≠sticas cr√≠ticas
                try { cache['temp'] = await service.getCharacteristic(CHAR_TEMP); } catch(e) { log("Error Temp: " + e); }
                try { cache['target'] = await service.getCharacteristic(CHAR_TARGET); } catch(e) { log("Error Target: " + e); }

                // UI
                document.getElementById('connectPanel').style.display = 'none';
                document.getElementById('app').style.display = 'block';

                // Iniciar bucle de lectura
                startPolling();

            } catch (err) {
                alert("Error: " + err);
            }
        }

        async function startPolling() {
            pollingInterval = setInterval(async () => {
                if (cache['temp']) {
                    const val = await cache['temp'].readValue();
                    const cel = val.getUint16(0, true) / 10;
                    document.getElementById('tempDisplay').innerText = cel.toFixed(1) + "¬∞C";
                }
            }, 2000);
        }

        async function setTemperature(val = null) {
            if (!cache['target']) return alert("Error: No hay conexi√≥n de control");
            
            // Si no nos pasan valor, lo tomamos del input
            const num = val ? val : parseInt(document.getElementById('targetInput').value);
            
            // Actualizar UI visualmente
            document.getElementById('targetDisplay').innerText = num;
            document.getElementById('targetInput').value = num;

            // Enviar comando Bluetooth
            const buffer = new Uint16Array([num * 10]);
            await cache['target'].writeValue(buffer);
            log(`Comando enviado: ${num}¬∞C`);
        }

        // --- L√ìGICA MODO CATADOR ---
        async function startCata() {
            const pasos = [175, 180, 185, 190, 195];
            const tiempoEntrePasos = 45000; // 45 segundos (ajustable)
            
            let btn = document.querySelector('.btn-cata');
            let status = document.getElementById('cataStatus');
            
            btn.disabled = true;
            btn.style.background = "#555";
            btn.innerText = "‚è≥ SESI√ìN EN CURSO...";

            for (let i = 0; i < pasos.length; i++) {
                let temp = pasos[i];
                status.innerText = `Paso ${i+1}/${pasos.length}: Calentando a ${temp}¬∞C`;
                log(`[CATADOR] Subiendo a ${temp}¬∞C`);
                
                await setTemperature(temp);
                
                // Esperar tiempo (Countdown visual simple)
                if (i < pasos.length - 1) {
                    await new Promise(r => setTimeout(r, tiempoEntrePasos));
                }
            }

            status.innerText = "‚úÖ Sesi√≥n Finalizada (195¬∞C)";
            btn.disabled = false;
            btn.innerText = "‚ñ∂ INICIAR SESI√ìN";
            btn.style.background = "linear-gradient(45deg, #8e44ad, #c0392b)";
            alert("¬°Sesi√≥n de cata terminada! Disfruta.");
        }

        // --- L√ìGICA ESC√ÅNER BATER√çA ---
        async function scanServices() {
            if (!serverCache) return alert("Primero conecta el dispositivo");
            log("--- INICIANDO ESCANEO PROFUNDO ---");
            
            try {
                const service = await serverCache.getPrimaryService(SERVICE_MAIN);
                const characteristics = await service.getCharacteristics();
                
                for (const c of characteristics) {
                    try {
                        const val = await c.readValue();
                        // Intentar leer valor byte simple (0-255)
                        const intVal = val.getUint8(0); 
                        // Intentar leer short (como temp)
                        const shortVal = val.getUint16(0, true);

                        log(`UUID: ...${c.uuid.slice(4, 8)} | Val(8): ${intVal} | Val(16): ${shortVal}`);

                        // Si parece una bater√≠a (0-100) y NO es una de las temperaturas
                        if (intVal > 0 && intVal <= 100 && intVal !== 32) { // 32 suele ser un byte basura
                            document.getElementById('batDisplay').innerText = intVal + "% (Posible)";
                            log(`¬°ENCONTRADO POSIBLE BATER√çA! UUID termina en: ${c.uuid.slice(4,8)}`);
                        }
                    } catch (err) {
                        log(`UUID Protegido/Escritura: ...${c.uuid.slice(4, 8)}`);
                    }
                }
            } catch (e) {
                log("Error escaneo: " + e);
            }
            log("--- FIN ESCANEO ---");
        }
    </script>
</body>
</html>
