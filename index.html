<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Crafty+ (UUID Fix)</title>
    <style>
        body { font-family: monospace; background-color: #000; color: #0f0; text-align: center; padding: 20px; }
        .box { border: 2px solid #333; padding: 20px; margin: 10px auto; max-width: 300px; border-radius: 10px; background: #111; }
        .val { font-size: 40px; font-weight: bold; color: white; }
        button { background: #d35400; color: white; border: none; padding: 15px; width: 100%; font-size: 18px; cursor: pointer; border-radius: 5px; margin-top: 10px;}
        input { padding: 10px; font-size: 18px; width: 80px; text-align: center; }
        #logs { text-align: left; color: #666; font-size: 12px; margin-top: 20px; border-top: 1px solid #333; padding-top: 10px;}
    </style>
</head>
<body>

    <h1>üî• CRAFTY+ TERMINAL</h1>
    
    <div id="connectionPanel">
        <p>Estado: <span id="status">Desconectado</span></p>
        <button onclick="connect()">üîå CONECTAR</button>
    </div>

    <div id="dashboard" style="display:none;">
        <div class="box">
            <div>TEMPERATURA</div>
            <div id="tempVal" class="val">--.-¬∞C</div>
        </div>
        
        <div class="box">
            <div>OBJETIVO</div>
            <input type="number" id="targetInput" value="180">
            <button onclick="setTemp()" style="background:#2980b9;">ENVIAR</button>
        </div>

        <div class="box">
            <div>BATER√çA</div>
            <div id="batVal" class="val">--%</div>
        </div>
    </div>

    <div id="logs"></div>

    <script>
        // === UUIDs CORREGIDOS (Versi√≥n Standard S&B) ===
        // El sufijo com√∫n es "-5354-4f52-5a26-4249434b454c"
        const SERVICE_UUID = '00000001-5354-4f52-5a26-4249434b454c'; 
        
        // Caracter√≠sticas
        const CHAR_CURRENT_TEMP = '00000011-5354-4f52-5a26-4249434b454c'; // Lee temp actual
        const CHAR_TARGET_TEMP  = '00000021-5354-4f52-5a26-4249434b454c'; // Escribe temp objetivo
        const CHAR_BATTERY      = '00000040-5354-4f52-5a26-4249434b454c'; // Lee bater√≠a

        let deviceCache = null;
        let charCache = {};

        function log(txt) {
            console.log(txt);
            document.getElementById('logs').innerHTML += `> ${txt}<br>`;
        }

        async function connect() {
            try {
                document.getElementById('status').innerText = "Buscando...";
                
                // 1. Solicitar dispositivo con el servicio expl√≠cito
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: false, 
                    filters: [{ namePrefix: "STORZ" }], // Filtramos por nombre para evitar ruido
                    optionalServices: [SERVICE_UUID]    // ¬°CR√çTICO! Debemos pedir permiso para este servicio
                });

                deviceCache = device;
                log(`Dispositivo: ${device.name}`);
                
                const server = await device.gatt.connect();
                log("Servidor GATT conectado");

                // 2. Obtener el servicio primario
                const service = await server.getPrimaryService(SERVICE_UUID);
                log("Servicio encontrado ‚úÖ");

                // 3. Obtener caracter√≠sticas (Endpoints)
                charCache['current'] = await service.getCharacteristic(CHAR_CURRENT_TEMP);
                charCache['target']  = await service.getCharacteristic(CHAR_TARGET_TEMP);
                charCache['battery'] = await service.getCharacteristic(CHAR_BATTERY);
                
                log("Todo listo. Leyendo datos...");
                
                // Mostrar interfaz
                document.getElementById('connectionPanel').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';

                // Iniciar bucle de lectura
                setInterval(readData, 2000);

            } catch (error) {
                log("‚ùå ERROR: " + error);
                alert("Error de conexi√≥n: " + error + "\n\nIntenta 'Olvidar' el dispositivo en la config Bluetooth de Android y reintenta.");
            }
        }

        async function readData() {
            if(!charCache['current']) return;
            
            try {
                // Leer Temperatura
                const tempVal = await charCache['current'].readValue();
                const tempC = tempVal.getUint16(0, true) / 10; // Little Endian, dividido por 10
                document.getElementById('tempVal').innerText = tempC.toFixed(1) + "¬∞C";

                // Leer Bater√≠a
                const batVal = await charCache['battery'].readValue();
                const batPerc = batVal.getUint16(0, true);
                document.getElementById('batVal').innerText = batPerc + "%";
                
            } catch (e) {
                log("Error lectura: " + e);
            }
        }

        async function setTemp() {
            try {
                const val = parseInt(document.getElementById('targetInput').value);
                const buffer = new Uint16Array([val * 10]); // Multiplicar por 10 (ej: 180 -> 1800)
                await charCache['target'].writeValue(buffer);
                log(`Temperatura enviada: ${val}¬∞C`);
            } catch (e) {
                log("Error escritura: " + e);
            }
        }
    </script>
</body>
</html>
