<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crafty+ Controller V3</title>
    <style>
        body { font-family: 'Verdana', sans-serif; background-color: #000; color: #fff; text-align: center; padding: 20px; margin: 0; }
        
        /* ESTADO DE CONEXI√ìN */
        .header { margin-bottom: 20px; }
        .badge-ok { background-color: #00ff00; color: #000; padding: 5px 10px; border-radius: 5px; font-weight: bold; }
        .badge-no { background-color: #ff0000; color: #fff; padding: 5px 10px; border-radius: 5px; font-weight: bold; }

        /* TARJETAS */
        .card { background: #111; border: 1px solid #333; border-radius: 15px; padding: 20px; margin: 15px auto; max-width: 350px; }
        
        .temp-big { font-size: 50px; font-weight: bold; color: #00e5ff; text-shadow: 0 0 10px rgba(0, 229, 255, 0.5); margin: 10px 0; }
        .label { font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        
        /* BOTONES */
        button { border: none; padding: 18px; font-size: 16px; font-weight: bold; border-radius: 10px; cursor: pointer; width: 100%; margin-top: 10px; touch-action: manipulation; }
        .btn-connect { background: #fff; color: #000; }
        .btn-on { background: linear-gradient(to right, #ff416c, #ff4b2b); color: white; font-size: 20px; }
        .btn-off { background: #333; color: #fff; }
        
        /* INPUT */
        input[type="number"] { background: #222; border: 1px solid #444; color: #fff; font-size: 24px; padding: 10px; width: 80px; text-align: center; border-radius: 8px; }

        /* LOGS */
        #logs { font-family: monospace; font-size: 10px; color: #666; text-align: left; margin-top: 30px; border-top: 1px solid #333; padding-top: 10px; height: 100px; overflow-y: auto; }
    </style>
</head>
<body>

    <div class="header">
        <h2>üî• CRAFTY+ V3</h2>
        <span id="statusBadge" class="badge-no">DESCONECTADO</span>
    </div>

    <div id="screen-connect">
        <div class="card">
            <p>Aseg√∫rate de tener Bluetooth y Ubicaci√≥n activados.</p>
            <button class="btn-connect" onclick="conectar()">üîå CONECTAR AHORA</button>
        </div>
    </div>

    <div id="screen-app" style="display:none;">
        
        <div class="card">
            <div class="label">Temperatura Actual</div>
            <div id="tempActual" class="temp-big">--.-¬∞C</div>
            
            <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                <div>
                    <div class="label">Objetivo</div>
                    <div id="tempTarget" style="color: #ff4b2b; font-weight: bold; font-size: 18px;">--¬∞C</div>
                </div>
                <div>
                    <div class="label">Bater√≠a</div>
                    <div id="batteryLevel" style="color: #00ff00; font-weight: bold; font-size: 18px;">--%</div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="label">Configurar</div>
            <br>
            <input type="number" id="inputTemp" value="180"> ¬∞C
            
            <button class="btn-on" onclick="encenderVape()">üî• CALENTAR</button>
            <button class="btn-off" onclick="apagarVape()">‚ùÑÔ∏è DETENER</button>
        </div>
    </div>

    <div id="logs">Esperando acci√≥n...</div>

    <script>
        // --- TUS UUIDS CONFIRMADOS ---
        const SUFFIX = '-4c45-4b43-4942-265a524f5453';
        const SERVICE_MAIN = '00000001' + SUFFIX;
        
        const UUID_TEMP_ACTUAL = '00000011' + SUFFIX; // Read
        const UUID_TEMP_TARGET = '00000021' + SUFFIX; // Read/Write
        const UUID_BATERIA     = '00000041' + SUFFIX; // Read (Confirmado en tu captura)

        // Cache de caracter√≠sticas
        let cache = {
            temp: null,
            target: null,
            batt: null
        };
        let loopInterval = null;

        function log(msg) {
            const d = new Date();
            const time = d.toLocaleTimeString();
            const l = document.getElementById('logs');
            l.innerHTML = `[${time}] ${msg}<br>` + l.innerHTML;
        }

        async function conectar() {
            try {
                log("Buscando dispositivo...");
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'STORZ' }],
                    optionalServices: [SERVICE_MAIN]
                });

                log("Conectando...");
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_MAIN);
                
                // Mapear caracter√≠sticas
                log("Obteniendo caracter√≠sticas...");
                cache.temp   = await service.getCharacteristic(UUID_TEMP_ACTUAL);
                cache.target = await service.getCharacteristic(UUID_TEMP_TARGET);
                cache.batt   = await service.getCharacteristic(UUID_BATERIA);

                // UI Update
                document.getElementById('screen-connect').style.display = 'none';
                document.getElementById('screen-app').style.display = 'block';
                document.getElementById('statusBadge').className = 'badge-ok';
                document.getElementById('statusBadge').innerText = "CONECTADO";
                log("¬°Conexi√≥n exitosa!");

                // Iniciar bucle de lectura (Polling)
                iniciarLecturaConstante();

            } catch (error) {
                alert("Error: " + error);
                log(error);
            }
        }

        function iniciarLecturaConstante() {
            // Leer datos cada 1.5 segundos
            loopInterval = setInterval(async () => {
                if (!cache.temp || !cache.batt) return;

                try {
                    // 1. Leer Temperatura Actual
                    const valTemp = await cache.temp.readValue();
                    const tempC = valTemp.getUint16(0, true) / 10;
                    document.getElementById('tempActual').innerText = tempC.toFixed(1) + "¬∞C";

                    // 2. Leer Bater√≠a
                    const valBat = await cache.batt.readValue();
                    const batP = valBat.getUint16(0, true);
                    document.getElementById('batteryLevel').innerText = batP + "%";

                    // 3. Leer Objetivo (Para saber si est√° ON u OFF)
                    const valTarget = await cache.target.readValue();
                    const targetC = valTarget.getUint16(0, true) / 10;
                    document.getElementById('tempTarget').innerText = targetC > 0 ? targetC + "¬∞C" : "OFF";

                } catch (e) {
                    console.log("Error lectura ciclo: " + e);
                }
            }, 1500);
        }

        async function encenderVape() {
            if (!cache.target) return alert("No conectado");
            
            const grados = document.getElementById('inputTemp').value;
            const valor = grados * 10; // Ejemplo 180 -> 1800

            try {
                // ESTRATEGIA DOBLE GOLPE:
                // 1. Enviamos 0 para 'despertar' la interrupci√≥n
                // log("Despertando...");
                // await escribir(0);
                
                // 2. Esperamos 200ms
                // await new Promise(r => setTimeout(r, 200));

                // 3. Enviamos temperatura real
                log(`Enviando orden: ${grados}¬∞C`);
                await escribir(valor);
                
                alert(`¬°Comando enviado! El LED deber√≠a ponerse ROJO.`);

            } catch (e) {
                log("Error al encender: " + e);
                alert("Error enviando comando");
            }
        }

        async function apagarVape() {
            try {
                log("Apagando...");
                await escribir(0);
                alert("Calentamiento detenido.");
            } catch (e) { log(e); }
        }

        // Funci√≥n auxiliar para escribir datos correctos
        async function escribir(valor) {
            if (!cache.target) return;
            // Buffer Little Endian (Vital para S&B)
            const buffer = new ArrayBuffer(2);
            new DataView(buffer).setUint16(0, valor, true);
            await cache.target.writeValue(buffer);
        }

    </script>
</body>
</html>
