<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S&B Web Controller</title>
    <style>
        body {
            background-color: #0d0d0d;
            color: #ffffff;
            font-family: 'Courier New', Courier, monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
            min-height: 100vh;
            margin: 0;
        }
        .card {
            background-color: #1a1a1a;
            border: 1px solid #333;
            border-radius: 15px;
            padding: 20px;
            margin: 10px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        .btn-connect {
            background: linear-gradient(90deg, #8e44ad, #c0392b);
            color: white;
            border: none;
            padding: 15px;
            width: 100%;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
        }
        .btn-action {
            background-color: #e67e22;
            color: white;
            border: none;
            padding: 15px;
            width: 100%;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }
        input[type="number"] {
            background-color: #333;
            color: white;
            padding: 10px;
            font-size: 24px;
            width: 80px;
            text-align: center;
            border-radius: 5px;
            border: 1px solid #555;
        }
        /* CONSOLA DE ERRORES EN PANTALLA */
        #console-log {
            width: 90%;
            background-color: #000;
            border: 1px solid #444;
            color: #0f0;
            font-size: 12px;
            padding: 10px;
            margin-top: 20px;
            height: 150px;
            overflow-y: scroll;
            text-align: left;
            font-family: monospace;
        }
    </style>
</head>
<body>

    <div class="card">
        <h3>Paso 1: Conexión</h3>
        <button id="btnConnect" class="btn-connect" onclick="iniciarConexion()">
            BUSCAR DISPOSITIVO
        </button>
        <p id="status">Estado: Esperando...</p>
    </div>

    <div class="card">
        <h3>Paso 2: Control</h3>
        <div style="font-size: 40px; font-weight: bold; margin-bottom: 10px;">
            <span id="tempActual">--</span>°C
        </div>
        
        <input type="number" id="inputTemp" value="180"> °C
        <button class="btn-action" onclick="fijarTemperatura()">CALENTAR (ON)</button>
        <button class="btn-action" style="background-color:#444" onclick="apagar()">DETENER (OFF)</button>
        
        <p>Batería: <span id="batteryLevel">--</span>%</p>
    </div>

    <div id="console-log">Log del sistema iniciado...</div>

    <script>
        // --- UTILIDAD DE LOG EN PANTALLA ---
        function log(msg, color = "#0f0") {
            const consoleDiv = document.getElementById('console-log');
            const newLine = document.createElement('div');
            newLine.style.color = color;
            newLine.innerText = `> ${msg}`;
            consoleDiv.appendChild(newLine);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
            console.log(msg);
        }

        // --- VERIFICACIÓN INICIAL ---
        if (!navigator.bluetooth) {
            log("ERROR CRÍTICO: Tu navegador NO soporta Web Bluetooth.", "red");
            log("Usa Chrome en Android o Bluefy en iPhone.", "red");
            document.getElementById('btnConnect').disabled = true;
            document.getElementById('btnConnect').innerText = "NAVEGADOR NO COMPATIBLE";
        } else {
            log("API Bluetooth detectada correctamente.");
        }

        if (window.location.protocol === 'http:') {
            log("ADVERTENCIA: Estás en HTTP. Bluetooth requiere HTTPS o localhost.", "yellow");
        }

        // --- VARIABLES ---
        let dispositivoConectado = null;
        let charTempWrite = null; // Para escribir (0021)
        
        const SERVICE_UUID = '00000001-5354-4f52-5a26-4249434b454c';
        const CHAR_BATTERY = '00000003-5354-4f52-5a26-4249434b454c';
        const CHAR_TEMP_READ = '00000011-5354-4f52-5a26-4249434b454c';
        const CHAR_TEMP_WRITE = '00000021-5354-4f52-5a26-4249434b454c';

        // --- FUNCIÓN DE CONEXIÓN ---
        async function iniciarConexion() {
            log("Iniciando escaneo...");
            
            try {
                // Opción A: Filtro Específico (Más seguro si funciona)
                /*
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [SERVICE_UUID] }]
                });
                */

                // Opción B: Aceptar todo (Mejor para encontrarlo si el filtro falla)
                const device = await navigator.bluetooth.requestDevice({
                     acceptAllDevices: true,
                     optionalServices: [SERVICE_UUID]
                });

                log(`Dispositivo seleccionado: ${device.name}`);
                document.getElementById('status').innerText = "Conectando...";
                
                const server = await device.gatt.connect();
                log("Servidor GATT conectado.");

                const service = await server.getPrimaryService(SERVICE_UUID);
                log("Servicio S&B encontrado.");

                // 1. Configurar Batería
                try {
                    const batChar = await service.getCharacteristic(CHAR_BATTERY);
                    const val = await batChar.readValue();
                    const batNivel = val.getUint16(0, true);
                    document.getElementById('batteryLevel').innerText = batNivel;
                    log(`Batería leída: ${batNivel}%`);
                } catch (e) { log("Error leyendo batería: " + e, "orange"); }

                // 2. Configurar Temperatura Actual
                try {
                    const tempReadChar = await service.getCharacteristic(CHAR_TEMP_READ);
                    await tempReadChar.startNotifications();
                    tempReadChar.addEventListener('characteristicvaluechanged', (e) => {
                        const t = e.target.value.getUint16(0, true)
