<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CRAFTY+ V15 FINAL FIX</title>
    <style>
        /* ESTILO V12 (Dise√±o Moderno) */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #000; color: #fff; text-align: center; padding: 15px; margin: 0; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        .header { display: flex; justify-content: space-between; align-items: center; max-width: 400px; margin: 0 auto 15px auto; padding: 0 10px; }
        .logo { font-weight: 800; font-size: 18px; letter-spacing: -0.5px; }
        .logo span { color: #00e5ff; }
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 700; background: #222; color: #555; }
        .badge.online { background: #00ff00; color: #000; box-shadow: 0 0 8px rgba(0,255,0,0.5); }

        .screen { max-width: 380px; margin: 0 auto; display: none; }
        .visible { display: block; animation: fadein 0.3s; }
        
        .card { background: #111; border-radius: 20px; padding: 20px; margin-bottom: 12px; border: 1px solid #222; position: relative; }

        .temp-display { position: relative; height: 100px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; }
        .temp-val { font-size: 80px; font-weight: 200; line-height: 1; letter-spacing: -4px; }
        .temp-unit { font-size: 20px; color: #666; position: absolute; top: 10px; right: 20px; }
        
        .grid-info { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
        .mini-stat { background: #1a1a1a; padding: 10px; border-radius: 12px; }
        .label { font-size: 9px; color: #888; text-transform: uppercase; margin-bottom: 2px; }
        .val { font-size: 16px; font-weight: 700; }
        .orange { color: #ff9f43; } .green { color: #2ecc71; }

        .control-bar { display: flex; align-items: center; justify-content: space-between; background: #1a1a1a; border-radius: 16px; padding: 6px; margin-bottom: 15px; }
        .btn-round { width: 55px; height: 55px; border-radius: 12px; border: none; background: #333; color: #fff; font-size: 28px; cursor: pointer; }
        .btn-round:active { background: #555; transform: scale(0.92); }
        input[type="number"] { background: transparent; border: none; color: #fff; font-size: 32px; width: 90px; text-align: center; font-weight: 600; }

        .btn-main { width: 100%; border: none; padding: 16px; border-radius: 14px; font-size: 15px; font-weight: 700; cursor: pointer; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-main:active { transform: scale(0.98); filter: brightness(0.9); }
        
        .btn-heat { background: linear-gradient(135deg, #ff6b6b, #ee5253); color: white; }
        .btn-boost { background: linear-gradient(135deg, #feca57, #ff9f43); color: #000; }
        .btn-cata { background: linear-gradient(135deg, #5f27cd, #341f97); color: white; }
        .btn-stop { background: #2d3436; color: #aaa; }
        .btn-disco { background: transparent; border: 1px solid #333; color: #555; font-size: 11px; padding: 12px; margin-top: 15px; }

        .status-text { font-size: 12px; color: #6c5ce7; font-weight: 600; height: 20px; margin: 5px 0; }
        
        @keyframes fadein { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="header">
        <div class="logo">CRAFTY<span>+</span> V15</div>
        <div id="statusBadge" class="badge">OFFLINE</div>
    </div>

    <div id="view-connect" class="screen visible">
        <div class="card" style="padding: 60px 20px; margin-top: 40px;">
            <div style="font-size: 60px; margin-bottom: 20px;">üõ°Ô∏è</div>
            <p style="color: #666; font-size: 14px;">Motor Blindado V15<br>Insistencia Verificada</p>
            <button class="btn-main btn-heat" style="margin-top: 30px;" onclick="conectar()">CONECTAR</button>
        </div>
    </div>

    <div id="view-app" class="screen">
        
        <div class="card">
            <div class="temp-display">
                <span id="tempActual" class="temp-val">--</span>
                <span class="temp-unit">¬∞C</span>
            </div>
            
            <div class="grid-info">
                <div class="mini-stat">
                    <div class="label">OBJETIVO</div>
                    <div id="tempTarget" class="val orange">--¬∞C</div>
                </div>
                <div class="mini-stat">
                    <div class="label">BATER√çA</div>
                    <div id="batteryLevel" class="val green">--%</div>
                </div>
            </div>
        </div>

        <div class="card">
            <div id="statusText" class="status-text"></div>

            <div class="control-bar">
                <button class="btn-round" onclick="cambioManual(-1)">-</button>
                <input type="number" id="inputTemp" value="180" readonly>
                <button class="btn-round" onclick="cambioManual(1)">+</button>
            </div>
            
            <button class="btn-main btn-heat" onclick="accionEncender()">
                <span>üî•</span> FIJAR TEMPERATURA
            </button>
            <button class="btn-main btn-boost" onclick="accionBoost()">
                <span>‚ö°</span> BOOST (+15¬∞C)
            </button>
            
            <hr style="border-color:#222; margin: 15px 0;">
            
            <button id="btnCata" class="btn-main btn-cata" onclick="iniciarCataV15()">
                <span>üç∑</span> MODO CATADOR
            </button>
            
            <button class="btn-main btn-stop" onclick="accionApagar()">‚ùÑÔ∏è APAGAR</button>
            <button class="btn-main btn-disco" onclick="desconectar()">DESCONECTAR</button>
        </div>
    </div>

    <script>
        const UUID = {
            MAIN:   '00000001-4c45-4b43-4942-265a524f5453',
            ACTUAL: '00000011-4c45-4b43-4942-265a524f5453',
            TARGET: '00000021-4c45-4b43-4942-265a524f5453',
            BATT:   '00000041-4c45-4b43-4942-265a524f5453',
            ON:     '00000081-4c45-4b43-4942-265a524f5453',
            OFF:    '00000091-4c45-4b43-4942-265a524f5453'
        };

        let device, char = {}, loop, cataRun = false;
        let isWriting = false; 
        let debounceTimer = null;

        async function conectar() {
            try {
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'STORZ' }],
                    optionalServices: [UUID.MAIN]
                });
                device.addEventListener('gattserverdisconnected', onDisconnect);
                
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(UUID.MAIN);

                char.actual = await service.getCharacteristic(UUID.ACTUAL);
                char.target = await service.getCharacteristic(UUID.TARGET);
                char.batt   = await service.getCharacteristic(UUID.BATT);
                char.on     = await service.getCharacteristic(UUID.ON);
                char.off    = await service.getCharacteristic(UUID.OFF);

                uiConnected();
                loop = setInterval(leerDatos, 1000);

            } catch (e) { alert("Error: " + e); }
        }

        function uiConnected() {
            document.getElementById('view-connect').classList.remove('visible');
            document.getElementById('view-app').classList.add('visible');
            document.getElementById('statusBadge').innerText = "ONLINE";
            document.getElementById('statusBadge').classList.add('online');
        }

        function onDisconnect() {
            clearInterval(loop);
            cataRun = false;
            location.reload();
        }

        function desconectar() {
            if(device?.gatt?.connected) device.gatt.disconnect();
            else onDisconnect();
        }

        async function leerDatos() {
            if(isWriting || !char.actual) return;
            
            try {
                const vT = await char.actual.readValue();
                document.getElementById('tempActual').innerText = (vT.getUint16(0, true)/10).toFixed(1);

                const vO = await char.target.readValue();
                const obj = vO.getUint16(0, true)/10;
                document.getElementById('tempTarget').innerText = obj > 0 ? obj + "¬∞C" : "OFF";

                const vB = await char.batt.readValue();
                document.getElementById('batteryLevel').innerText = vB.getUint16(0, true) + "%";
            } catch(e) {}
        }

        function cambioManual(delta) {
            const input = document.getElementById('inputTemp');
            let nuevoValor = parseInt(input.value) + delta;
            
            if(nuevoValor > 210) nuevoValor = 210;
            if(nuevoValor < 40) nuevoValor = 40;

            input.value = nuevoValor;
            if(debounceTimer) clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => { enviarComandoSeguro(nuevoValor); }, 400); 
        }

        async function enviarComandoSeguro(temp) {
            isWriting = true;
            document.getElementById('statusText').innerText = "Actualizando...";

            try {
                await write(char.target, temp * 10);
                await write(char.on, 1);
                await new Promise(r => setTimeout(r, 200));
                document.getElementById('statusText').innerText = "";
            } catch(e) { console.log("Error escritura"); }
            isWriting = false;
        }

        async function accionEncender(valOverride = null) {
            const val = valOverride || document.getElementById('inputTemp').value;
            await enviarComandoSeguro(val);
            if(navigator.vibrate) navigator.vibrate(50);
        }

        async function accionBoost() {
            let actual = parseInt(document.getElementById('inputTemp').value);
            let target = Math.min(actual + 15, 210);
            document.getElementById('inputTemp').value = target; 
            await accionEncender(target);
            alert(`üöÄ BOOST: ${target}¬∞C`);
        }

        async function accionApagar() {
            cataRun = false;
            isWriting = true;
            try {
                await write(char.off, 1);
                await write(char.target, 0);
            } catch(e) {}
            isWriting = false;
        }

        // --- MODO CATADOR V15 (PARANOICO) ---
        async function iniciarCataV15() {
            if(cataRun) return;
            cataRun = true;
            
            const pasos = [175, 185, 195];
            const btn = document.getElementById('btnCata');
            const status = document.getElementById('statusText');
            
            btn.style.background = "#333";
            btn.innerHTML = "<span>‚õî</span> DETENER CATA";
            btn.onclick = () => location.reload();

            for(let i=0; i<pasos.length; i++) {
                if(!cataRun) break;
                const T = pasos[i];
                
                status.innerText = `Paso ${i+1}: Enviando ${T}¬∞C...`;
                document.getElementById('inputTemp').value = T;
                
                // 1. ENV√çO CON VERIFICACI√ìN (INSISTENCIA)
                let confirmado = false;
                let intentos = 0;
                
                isWriting = true; // Bloqueamos lectura normal
                while(!confirmado && intentos < 5 && cataRun) {
                    try {
                        console.log(`Intento ${intentos+1} para ${T}¬∞C`);
                        // Enviar orden
                        await write(char.target, T * 10);
                        await write(char.on, 1);
                        
                        // Esperar un momento
                        await new Promise(r => setTimeout(r, 800));
                        
                        // VERIFICAR SI OBEDECI√ì
                        const check = await char.target.readValue();
                        const valCheck = check.getUint16(0, true) / 10;
                        
                        if(Math.abs(valCheck - T) < 1) {
                            confirmado = true;
                            console.log("¬°Confirmado!");
                        } else {
                            status.innerText = `Reintentando ${T}¬∞C...`;
                        }
                    } catch(e) { console.log("Error verificaci√≥n"); }
                    intentos++;
                }
                isWriting = false; // Liberamos

                if(!confirmado) {
                    alert("El dispositivo no responde. ¬øEst√° encendido?");
                    break;
                }

                // 2. Esperar llegada
                status.innerText = `Subiendo a ${T}¬∞C...`;
                await esperarTemp(T);
                if(!cataRun) break;

                // 3. Cuenta atr√°s
                for(let s=45; s>0; s--) {
                    if(!cataRun) break;
                    status.innerText = `üî• Saboreando ${T}¬∞C - ${s}s`;
                    await new Promise(r => setTimeout(r, 1000));
                }
            }
            
            if(cataRun) {
                status.innerText = "¬°Cata Finalizada!";
                alert("Sesi√≥n Terminada");
                cataRun = false;
                btn.style.background = "";
                btn.innerHTML = "<span>üç∑</span> MODO CATADOR";
                btn.onclick = iniciarCataV15;
            }
        }

        async function esperarTemp(meta) {
            return new Promise(resolve => {
                let safety = 0;
                const check = setInterval(() => {
                    safety++;
                    const curr = parseFloat(document.getElementById('tempActual').innerText);
                    // Margen de 3 grados o timeout 90s
                    if(!cataRun || curr >= (meta - 3) || safety > 90) {
                        clearInterval(check);
                        resolve();
                    }
                }, 1000);
            });
        }

        async function write(c, v) {
            if(!c) return;
            const b = new ArrayBuffer(2);
            new DataView(b).setUint16(0, v, true);
            await c.writeValue(b);
        }
    </script>
</body>
</html>
