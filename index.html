<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Crafty+ (Modo Todo Terreno)</title>
    <style>
        body { font-family: sans-serif; background-color: #121212; color: #00ff00; text-align: center; padding: 20px; }
        h1 { color: #ffffff; margin-bottom: 5px; }
        small { color: #888; display: block; margin-bottom: 20px; }
        .data-box { border: 1px solid #444; padding: 15px; margin: 10px auto; max-width: 300px; border-radius: 8px; background: #1e1e1e; }
        .big-text { font-size: 35px; font-weight: bold; color: white; }
        button { background: #ff6600; color: white; border: none; padding: 15px 30px; font-size: 16px; margin-top: 10px; cursor: pointer; border-radius: 5px; width: 100%; max-width: 300px; }
        input { padding: 10px; font-size: 18px; width: 60px; text-align: center; border-radius: 4px; border: none; }
        #status { color: #ffcc00; margin: 15px 0; font-weight: bold; }
        #debug { color: #555; font-size: 10px; margin-top: 30px; text-align: left; }
    </style>
</head>
<body>

    <h1>ü§ñ CRAFTY+ CLON</h1>
    <small>Versi√≥n: B√∫squeda Abierta</small>
    
    <div id="status">Esperando conexi√≥n...</div>

    <button id="btnConnect" onclick="connectToCrafty()">üîå BUSCAR DISPOSITIVOS</button>

    <div id="controls" style="display:none;">
        <div class="data-box">
            <div>üî• ACTUAL</div>
            <div id="currentTemp" class="big-text">--.-¬∞C</div>
        </div>

        <div class="data-box">
            <div>üéØ OBJETIVO</div>
            <br>
            <input type="number" id="targetInput" value="180"> ¬∞C
            <button onclick="writeTemperature()" style="background: #0099ff; margin-top: 10px;">ENVIAR CAMBIO</button>
        </div>

        <div class="data-box">
            <div>üîã BATER√çA</div>
            <div id="batteryLevel" class="big-text">--%</div>
        </div>
    </div>

    <div id="debug">Logs del sistema aparecer√°n aqu√≠...</div>

    <script>
        // --- CONFIGURACI√ìN ---
        const SB_SERVICE = '10100000-5354-4f52-5a26-4249434b454c';
        const UUID_TEMP_CURRENT = '10110001-5354-4f52-5a26-4249434b454c';
        const UUID_TEMP_TARGET  = '10110003-5354-4f52-5a26-4249434b454c';
        const UUID_BATTERY      = '10110004-5354-4f52-5a26-4249434b454c';

        let characteristicCache = {};

        function log(msg) {
            document.getElementById('debug').innerHTML += "> " + msg + "<br>";
            console.log(msg);
        }

        async function connectToCrafty() {
            try {
                document.getElementById('status').innerText = "üîç Buscando... selecciona tu Crafty";
                
                // CAMBIO IMPORTANTE: acceptAllDevices: true
                // Esto mostrar√° TODOS los dispositivos Bluetooth cercanos.
                // T√∫ debes seleccionar el que diga "STORZ&BICKEL" o "CRAFTY".
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: [SB_SERVICE]
                });

                document.getElementById('status').innerText = "Conectando a " + device.name + "...";
                log("Dispositivo seleccionado: " + device.name);

                const server = await device.gatt.connect();
                log("Servidor GATT conectado");

                const service = await server.getPrimaryService(SB_SERVICE);
                log("Servicio S&B encontrado");

                // Obtener caracter√≠sticas
                characteristicCache['current'] = await service.getCharacteristic(UUID_TEMP_CURRENT);
                characteristicCache['target'] = await service.getCharacteristic(UUID_TEMP_TARGET);
                characteristicCache['battery'] = await service.getCharacteristic(UUID_BATTERY);
                log("Caracter√≠sticas listas");

                // Mostrar interfaz
                document.getElementById('btnConnect').style.display = 'none';
                document.getElementById('controls').style.display = 'block';
                document.getElementById('status').innerText = "‚úÖ CONECTADO";
                document.getElementById('status').style.color = '#00ff00';

                // Iniciar lectura continua
                startMonitoring();

            } catch (error) {
                log("ERROR: " + error);
                document.getElementById('status').innerText = "‚ùå Fall√≥: " + error;
                alert("Error: " + error + ". \n\nAseg√∫rate de que el Crafty est√© encendido y NO conectado a otro celular.");
            }
        }

        async function startMonitoring() {
            setInterval(async () => {
                try {
                    // Leer Temperatura
                    const valTemp = await characteristicCache['current'].readValue();
                    const tempC = valTemp.getUint16(0, true) / 10;
                    document.getElementById('currentTemp').innerText = tempC.toFixed(1) + "¬∞C";

                    // Leer Bater√≠a
                    const valBat = await characteristicCache['battery'].readValue();
                    const batLevel = valBat.getUint16(0, true);
                    document.getElementById('batteryLevel').innerText = batLevel + "%";
                } catch (e) {
                    log("Error leyendo datos: " + e);
                }
            }, 2000); 
        }

        async function writeTemperature() {
            try {
                const inputVal = document.getElementById('targetInput').value;
                const targetVal = parseInt(inputVal) * 10; 
                const buffer = new Uint16Array([targetVal]); 
                await characteristicCache['target'].writeValue(buffer);
                alert("‚úÖ Temperatura enviada: " + inputVal + "¬∞C");
            } catch (e) {
                alert("Error escribiendo: " + e);
            }
        }
    </script>
</body>
</html>
