<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CRAFTY+ APP</title>
    <link rel="icon" type="image/x-icon" href="https://www.storz-bickel.com/media/favicon/default/favicon.ico">
    <style>
        /* --- ESTILOS CLONADOS (Pixel Perfect) --- */
        :root {
            --sb-orange: #f58220;
            --sb-blue: #002d5a; /* Azul oscuro barra inferior */
            --sb-grey: #4a4a4a;
            --bg-light: #ffffff;
        }

        body { 
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; 
            background-color: var(--bg-light); 
            color: #000; 
            text-align: center; 
            margin: 0; padding: 0;
            height: 100vh;
            display: flex; flex-direction: column;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* HEADER */
        .header { 
            padding: 10px 15px; 
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #eee;
            background: #fff;
        }
        .logo-img { height: 35px; } /* Espacio para logo real */
        
        .btn-disco {
            border: 1px solid var(--sb-orange); color: var(--sb-orange);
            background: #fff; padding: 5px 12px; border-radius: 4px;
            font-weight: bold; font-size: 12px; cursor: pointer;
        }

        /* PANTALLAS */
        .screen { flex: 1; display: none; flex-direction: column; }
        .visible { display: flex; }

        /* PANTALLA CONEXIÓN */
        #connect-view {
            justify-content: center; align-items: center; padding: 20px;
        }
        .connect-btn {
            width: 140px; height: 140px;
            border-radius: 50%;
            background: #f9f9f9;
            border: 2px solid #eee;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            transition: 0.2s;
        }
        .connect-btn:active { background: #eee; transform: scale(0.95); }
        .connect-icon { font-size: 40px; color: var(--sb-orange); margin-bottom: 5px; }

        /* PANTALLA PRINCIPAL */
        #app-view { justify-content: space-between; position: relative; }

        .main-content {
            flex: 1; display: flex; flex-direction: column; 
            align-items: center; justify-content: center;
            padding-bottom: 40px;
        }

        /* IMAGEN PRODUCTO */
        .device-img {
            width: 120px; height: auto; margin-bottom: 20px;
            opacity: 0.9;
        }

        /* TEMPERATURAS GRUESAS (Como la original) */
        .temp-big { 
            font-size: 60px; font-weight: 300; line-height: 1; 
            display: flex; align-items: flex-start;
        }
        .unit-big { font-size: 24px; margin-top: 5px; color: #666; }

        /* FILA DE CONTROL (+ 180 -) */
        .control-row {
            display: flex; align-items: center; gap: 30px; margin-top: 15px;
        }
        
        /* BOTONES TRIANGULARES NEGROS */
        .btn-triangle {
            width: 50px; height: 50px;
            background: #333; 
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%); /* Triángulo arriba */
            cursor: pointer; border: none;
        }
        .btn-triangle.down { transform: rotate(180deg); } /* Triángulo abajo */
        .btn-triangle:active { background: #000; }

        /* OBJETIVO AL CENTRO */
        .target-box { text-align: center; }
        .target-val { font-size: 40px; font-weight: bold; color: #333; }

        /* BATERÍA (Tira horizontal) */
        .battery-strip {
            width: 150px; height: 8px; background: #eee;
            border-radius: 4px; margin-top: 30px; overflow: hidden;
        }
        .battery-fill { height: 100%; background: #4CAF50; width: 0%; transition: 0.3s; }
        .battery-num { font-size: 12px; color: #999; margin-top: 5px; }

        /* BARRA INFERIOR AZUL */
        .nav-bar {
            height: 60px; background: var(--sb-blue);
            display: flex; justify-content: space-around; align-items: center;
        }
        .nav-btn {
            color: #8daec4; font-size: 10px; font-weight: bold;
            display: flex; flex-direction: column; align-items: center;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .nav-btn.active { color: #fff; }
        .nav-icon { font-size: 20px; margin-bottom: 4px; }

        /* LOGO STORZ CARGADO DESDE URL EXTERNA */
        .sb-logo-url {
            background-image: url('https://www.storz-bickel.com/static/version1673347355/frontend/StorzBickel/default/en_US/images/logo.svg');
            background-repeat: no-repeat;
            background-size: contain;
            width: 150px; height: 40px;
        }
    </style>
</head>
<body>

    <div class="header">
        <div class="sb-logo-url"></div> <button class="btn-disco" onclick="disconnect()">Desconectar</button>
    </div>

    <div id="connect-view" class="screen visible">
        <div class="connect-btn" onclick="connect()">
            <span class="connect-icon">⚡</span>
            <span style="font-weight:bold; color:#555;">CONECTAR</span>
        </div>
        <p style="color:#999; font-size:12px; margin-top:20px;">
            Asegúrate de que tu Crafty+ esté encendido.
        </p>
    </div>

    <div id="app-view" class="screen">
        
        <div class="main-content">
            <img src="https://www.storz-bickel.com/media/catalog/product/cache/27a9202574e4479dfa93880467770857/c/r/crafty_plus_v2_front_1.png" class="device-img" alt="Crafty+">

            <div class="temp-big">
                <span id="ui-current">--</span>
                <span class="unit-big">°C</span>
            </div>

            <div class="control-row">
                <button class="btn-triangle down" onclick="changeTemp(-1)"></button>
                
                <div class="target-box">
                    <div class="target-val" id="ui-target">180</div>
                    <div style="font-size:10px; color:#aaa; font-weight:bold;">OBJETIVO</div>
                </div>

                <button class="btn-triangle" onclick="changeTemp(1)"></button>
            </div>

            <div class="battery-strip">
                <div id="ui-batt-fill" class="battery-fill"></div>
            </div>
            <div class="battery-num" id="ui-batt-text">--%</div>

        </div>

        <div class="nav-bar">
            <div class="nav-btn active">
                <span class="nav-icon">⏻</span>
                Temperatura
            </div>
            <div class="nav-btn">
                <span class="nav-icon">⚙</span>
                Ajustes
            </div>
            <div class="nav-btn">
                <span class="nav-icon">ℹ</span>
                Info
            </div>
        </div>
    </div>

    <script>
        // --- MOTOR "AGRESIVO" (Estilo Nativo) ---
        // Sin colas complejas. Prioridad absoluta al usuario.
        
        const UUIDS = {
            s: '00000001-4c45-4b43-4942-265a524f5453', // Servicio
            curr: '00000011-4c45-4b43-4942-265a524f5453', // Actual
            targ: '00000021-4c45-4b43-4942-265a524f5453', // Objetivo
            batt: '00000041-4c45-4b43-4942-265a524f5453', // Batería
            on:   '00000081-4c45-4b43-4942-265a524f5453'  // Encender
        };

        let dev, char = {}, loop;
        let pauseReading = false; // El secreto de la velocidad
        let pauseTimeout;

        async function connect() {
            try {
                dev = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true, 
                    optionalServices: [UUIDS.s]
                });
                dev.addEventListener('gattserverdisconnected', onDisco);
                
                const server = await dev.gatt.connect();
                const service = await server.getPrimaryService(UUIDS.s);

                // Mapeo rápido
                char.curr = await service.getCharacteristic(UUIDS.curr);
                char.targ = await service.getCharacteristic(UUIDS.targ);
                char.batt = await service.getCharacteristic(UUIDS.batt);
                char.on   = await service.getCharacteristic(UUIDS.on);

                // UI Switch
                document.getElementById('connect-view').classList.remove('visible');
                document.getElementById('app-view').classList.add('visible');

                // Leer rápido al conectar
                readAll();
                // Bucle de lectura estándar (1.5s)
                loop = setInterval(readLoop, 1500);

            } catch(e) { alert("Error: " + e); }
        }

        function onDisco() {
            clearInterval(loop);
            location.reload();
        }

        function disconnect() {
            if(dev?.gatt?.connected) dev.gatt.disconnect();
            else location.reload();
        }

        // --- LECTURA ---
        async function readLoop() {
            // SI EL USUARIO ESTÁ TOCANDO BOTONES, NO LEEMOS NADA
            if(pauseReading) return;

            try {
                if(char.curr) {
                    const v = await char.curr.readValue();
                    document.getElementById('ui-current').innerText = (v.getUint16(0, true)/10).toFixed(0);
                }
                if(char.batt) {
                    const v = await char.batt.readValue();
                    const b = v.getUint16(0, true);
                    document.getElementById('ui-batt-text').innerText = b + "%";
                    document.getElementById('ui-batt-fill').style.width = b + "%";
                }
                // Leemos el objetivo real del vape SOLO si no estamos pausados
                if(char.targ) {
                    const v = await char.targ.readValue();
                    const t = v.getUint16(0, true)/10;
                    // Actualizamos visualmente si es diferente
                    if(t > 0) document.getElementById('ui-target').innerText = t;
                }
            } catch(e) {}
        }
        
        // Helper inicial
        async function readAll() { await readLoop(); }

        // --- ESCRITURA (CAMBIO DE TEMPERATURA) ---
        async function changeTemp(delta) {
            // 1. PAUSAR LECTURAS (Para que no se trabe el envío)
            pauseReading = true;
            if(pauseTimeout) clearTimeout(pauseTimeout);
            
            // Reactivar lecturas en 2.5 segundos si no tocas nada más
            pauseTimeout = setTimeout(() => { pauseReading = false; }, 2500);

            // 2. CALCULAR Y ACTUALIZAR VISUALMENTE (Instantáneo)
            const ui = document.getElementById('ui-target');
            let val = parseInt(ui.innerText) + delta;
            if(val > 210) val = 210;
            if(val < 40) val = 40;
            
            ui.innerText = val; // ¡Pum! Cambio visual inmediato

            // 3. ENVIAR FUEGO (Sin colas, sin esperas)
            try {
                const buffer = new ArrayBuffer(2);
                new DataView(buffer).setUint16(0, val * 10, true);
                
                // Enviar Objetivo
                await char.targ.writeValue(buffer);
                
                // Enviar Encendido (Buffer de 1)
                const bufOn = new ArrayBuffer(2);
                new DataView(bufOn).setUint16(0, 1, true);
                await char.on.writeValue(bufOn);
                
                // Vibrar si es posible
                if(navigator.vibrate) navigator.vibrate(30);

            } catch(e) {
                console.log("Error envío rápido");
                // Si falla, no pasa nada, el usuario volverá a picarle.
                // Así funciona la original.
            }
        }
    </script>
</body>
</html>
